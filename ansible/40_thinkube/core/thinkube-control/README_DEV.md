# thinkube-control Development Tools

This directory contains optimized development tools for faster iteration when working on thinkube-control.

## ‚ö†Ô∏è IMPORTANT: Template-Based Development

**thinkube-control is a Copier template**, not a regular application. This means:
- Development happens in `thinkube-control-temp/` (the template source)
- Deployment runs Copier to process templates with actual values
- Direct file syncing would break everything by deploying unprocessed templates

## üöÄ Quick Start

### Fast Development Deployment (30-60 seconds)
```bash
# Process templates and deploy quickly
./scripts/run_ansible.sh ansible/40_thinkube/core/thinkube-control/12_deploy_dev.yaml

# With development optimizations
./scripts/run_ansible.sh ansible/40_thinkube/core/thinkube-control/12_deploy_dev.yaml \
  -e @inventory/group_vars/all/development.yaml

# Skip template processing (DANGEROUS - only if no template changes)
./scripts/run_ansible.sh ansible/40_thinkube/core/thinkube-control/12_deploy_dev.yaml \
  -e skip_copier=true
```

### Kubernetes Manifests Only (10-15 seconds)
```bash
# Update only K8s manifests (processes templates)
./scripts/run_ansible.sh ansible/40_thinkube/core/thinkube-control/15_update_manifests.yaml
```

## üìÅ File Descriptions

### Playbooks
- **`12_deploy_dev.yaml`** - Development deployment with Copier processing
- **`15_update_manifests.yaml`** - Update K8s manifests only

### Configuration
- **`inventory/group_vars/all/development.yaml`** - Development optimization variables

## üéØ Development Workflow

### Initial Setup (Once)
```bash
# Run full deployment to set up infrastructure
./scripts/run_ansible.sh ansible/40_thinkube/core/thinkube-control/10_deploy.yaml
```

### Daily Development
```bash
# 1. Make changes in thinkube-control-temp/ (the template)
#    - Edit .py files, .vue files, .yaml.j2 templates, etc.
#    - Use {{ variable }} syntax in templates

# 2. Deploy changes (processes templates automatically)
./scripts/run_ansible.sh ansible/40_thinkube/core/thinkube-control/12_deploy_dev.yaml

# 3. If only changing non-template files (rare), skip Copier
./scripts/run_ansible.sh ansible/40_thinkube/core/thinkube-control/12_deploy_dev.yaml \
  -e skip_copier=true
```

### Configuration Changes
```bash
# When changing K8s manifests or configs
./scripts/run_ansible.sh ansible/40_thinkube/core/thinkube-control/15_update_manifests.yaml
```

### Full Rebuild (Rare)
```bash
# When you need fresh images built
./scripts/run_ansible.sh ansible/40_thinkube/core/thinkube-control/12_deploy_dev.yaml \
  -e skip_image_build=false
```

## ‚ö° Performance Comparison

| Operation | Original Time | Optimized Time | Method |
|-----------|--------------|----------------|---------|
| Full deployment | 10-15 min | 30-60 sec | `12_deploy_dev.yaml` |
| Template + deploy | 5-10 min | 30-60 sec | `12_deploy_dev.yaml` |
| Manifest update | 3-5 min | 10-15 sec | `15_update_manifests.yaml` |

## üîß Advanced Options

### Development Variables
Edit `inventory/group_vars/all/development.yaml` or pass as extra vars:

```bash
# Skip specific operations
-e skip_github_operations=true
-e skip_keycloak_setup=true
-e skip_database_setup=true

# Use direct kubectl instead of ArgoCD
-e use_kubectl_apply=true

# Skip image builds
-e skip_image_build=true
```

### Debugging
```bash
# View logs
ssh ${CONTROL_NODE} 'microk8s.kubectl logs -n thinkube-control -f deployment/thinkube-control-backend'

# Port forward for local access
ssh -L 8000:localhost:8000 ${CONTROL_NODE} \
  'microk8s.kubectl port-forward -n thinkube-control svc/backend 8000:8000'
```

## üìù Important Notes

### Template vs Instance
- **Template** (`thinkube-control-temp/`): Where you edit code
  - Contains Jinja2/Copier variables like `{{ domain_name }}`
  - This is your development directory
  - Changes here need Copier processing

- **Instance** (`shared-code/thinkube-control/`): Generated by Copier
  - Contains processed values like `thinkube.com`
  - Automatically created during deployment
  - DO NOT edit directly - changes will be lost!

### Common Pitfalls to Avoid
1. **Never sync template files directly** - They contain unprocessed variables
2. **Never edit in shared-code** - Changes will be overwritten
3. **Always run Copier** - Unless you're 100% sure no templates changed
4. **Test template syntax** - Invalid Jinja2 will break Copier

### Development Tips
- Use `skip_copier=true` only when editing pure Python/JS with no template vars
- The 30-60 second deployment time is mostly Copier processing and pod restarts
- Watch logs during development: `kubectl logs -n thinkube-control -f deployment/thinkube-control-backend`

## ü§ñ AI-Generated

These development tools were created to optimize the thinkube-control development workflow while respecting its template-based architecture.