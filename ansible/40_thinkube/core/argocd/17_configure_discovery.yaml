# Copyright 2025 Alejandro Martínez Corriá and the Thinkube contributors
# SPDX-License-Identifier: Apache-2.0

---
# ansible/40_thinkube/core/argocd/17_configure_discovery.yaml
# Description:
#   Configure service discovery for ArgoCD by creating a ConfigMap
#   that describes the service endpoints and metadata
#
# Requirements:
#   - ArgoCD must be deployed
#   - MicroK8s kubectl access
#
# Usage:
#   cd ~/thinkube
#   ./scripts/run_ansible.sh ansible/40_thinkube/core/argocd/17_configure_discovery.yaml
#
# Variables from inventory:
#   - domain_name: Base domain for the cluster
#   - kubeconfig: Path to kubeconfig file

- name: Configure ArgoCD service discovery
  hosts: microk8s_control_plane
  gather_facts: true
  
  tasks:
    - name: Create service discovery ConfigMap
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig }}"
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: thinkube-service-config
            namespace: argocd
            labels:
              thinkube.io/managed: "true"
              thinkube.io/service-type: "core"
              thinkube.io/service-name: "argocd"
          data:
            service.yaml: |
              service:
                name: argocd
                display_name: "ArgoCD"
                description: "GitOps continuous delivery for Kubernetes"
                type: core
                category: devops
                icon: /icons/tk_devops.svg
                
                endpoints:
                  - name: web
                    type: http
                    url: "https://argocd.{{ domain_name }}"
                    health_url: "https://argocd.{{ domain_name }}/api/version"
                    description: "Web UI and REST API"
                    primary: true
                    
                  - name: grpc
                    type: grpc
                    url: "argocd-grpc.{{ domain_name }}"
                    port: 443
                    health_service: "grpc.health.v1.Health"
                    description: "gRPC API for CLI and automation"
                    
                  - name: dex
                    type: http
                    url: "https://argocd.{{ domain_name }}"
                    health_url: "https://argocd.{{ domain_name }}/api/dex/healthz"
                    description: "Dex OIDC provider"
                    
                dependencies:
                  - redis

                scaling:
                  resource_type: deployment
                  resource_name: argocd-server
                  namespace: argocd
                  min_replicas: 1
                  can_disable: false

                environment_variables:
                  - name: ARGOCD_SERVER
                    value: "https://argocd.{{ domain_name }}"
                  - name: ARGOCD_GRPC_SERVER
                    value: "argocd-grpc.{{ domain_name }}:443"
                  - name: ARGOCD_AUTH_TOKEN
                    valueFrom:
                      secretKeyRef:
                        namespace: argocd
                        name: argo-cd-deployer-token
                        key: password
                  
    - name: Verify ConfigMap creation
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        api_version: v1
        kind: ConfigMap
        name: thinkube-service-config
        namespace: argocd
      register: configmap_info
      
    - name: Display ConfigMap status
      ansible.builtin.debug:
        msg: "Service discovery ConfigMap created for ArgoCD"
      when: configmap_info.resources | length > 0