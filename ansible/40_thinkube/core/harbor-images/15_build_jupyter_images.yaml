# Copyright 2025 Alejandro MartÃ­nez CorriÃ¡ and the Thinkube contributors
# SPDX-License-Identifier: Apache-2.0

---
# ansible/40_thinkube/core/harbor/15_build_jupyter_images.yaml
# Description:
#   Build and push custom Jupyter notebook images to Harbor library project
#   These images contain Thinkube services integration and specialized ML packages
#
# Requirements:
#   - Harbor registry deployed and accessible
#   - Podman installed on the k8s-snap control plane node
#   - Harbor admin credentials
#   - Base images mirrored to Harbor (13_mirror_public_images.yaml must run first)
#
# Usage:
#   cd ~/thinkube
#   # Build all images:
#   ./scripts/tk_ansible ansible/40_thinkube/core/harbor-images/15_build_jupyter_images.yaml
#
#   # Build individual images with tags:
#   ./scripts/tk_ansible ansible/40_thinkube/core/harbor-images/15_build_jupyter_images.yaml --tags ml-gpu
#   ./scripts/tk_ansible ansible/40_thinkube/core/harbor-images/15_build_jupyter_images.yaml --tags fine-tuning
#   ./scripts/tk_ansible ansible/40_thinkube/core/harbor-images/15_build_jupyter_images.yaml --tags agent-dev
#
# Available tags:
#   ml-gpu       - Build tk-jupyter-ml-gpu (base image)
#   fine-tuning  - Build tk-jupyter-fine-tuning (requires ml-gpu in registry)
#   agent-dev    - Build tk-jupyter-agent-dev (requires ml-gpu in registry)
#
# Variables from inventory:
#   - harbor_registry: Harbor registry hostname
#   - admin_password: Admin password from environment
#
# Dependencies:
#   - CORE-008: Harbor deployed
#   - 13_mirror_public_images.yaml: Base Jupyter images mirrored
#
# ğŸ¤– [AI-assisted]

- name: Build and Push Jupyter Images to Harbor
  hosts: k8s_control_plane
  gather_facts: true

  vars:
    local_base_images_dir: "{{ playbook_dir }}/base-images"
    base_images_dir: "/tmp/harbor-base-images"
    admin_password: "{{ lookup('env', 'ADMIN_PASSWORD') | default(lookup('env', 'ANSIBLE_BECOME_PASSWORD'), true) }}"

  tasks:
    # ==========================================================================
    # COMMON SETUP (always runs)
    # ==========================================================================
    - name: Create build context directory
      ansible.builtin.file:
        path: "{{ base_images_dir }}"
        state: directory
        mode: '0755'
      tags: [always]

    - name: Create temp directory for templated Containerfiles
      ansible.builtin.tempfile:
        state: directory
        suffix: jupyter-containerfiles
      register: temp_containerfiles_dir
      tags: [always]

    - name: Template Thinkube environment file for Jupyter images
      ansible.builtin.template:
        src: "{{ local_base_images_dir }}/thinkube_env.j2"
        dest: "{{ base_images_dir }}/.thinkube_env"
        mode: '0644'
      tags: [always]

    - name: Template iPython startup script for environment loading
      ansible.builtin.template:
        src: "{{ local_base_images_dir }}/templates/00-thinkube-env.py"
        dest: "{{ base_images_dir }}/00-thinkube-env.py"
        mode: '0644'
      tags: [always]

    - name: Template Jupyter test notebook
      ansible.builtin.template:
        src: "{{ local_base_images_dir }}/templates/test-thinkube-services.ipynb.j2"
        dest: "{{ base_images_dir }}/test-thinkube-services.ipynb"
        mode: '0644'
      tags: [always]

    - name: Copy Thinkube icons to build context
      ansible.builtin.copy:
        src: "{{ local_base_images_dir }}/icons/"
        dest: "{{ base_images_dir }}/icons/"
        mode: '0644'
      tags: [always]

    - name: Copy Jupyter flavor validation helper
      ansible.builtin.copy:
        src: "{{ local_base_images_dir }}/files/check_jupyter_flavor.py"
        dest: "{{ base_images_dir }}/check_jupyter_flavor.py"
        mode: '0644'
      tags: [always]

    - name: Copy Thinkube models helper
      ansible.builtin.copy:
        src: "{{ local_base_images_dir }}/files/thinkube_models.py"
        dest: "{{ base_images_dir }}/thinkube_models.py"
        mode: '0644'
      tags: [always]

    - name: Login to Harbor
      ansible.builtin.shell: |
        echo {{ admin_password }} | podman login {{ harbor_registry }} -u admin --password-stdin --tls-verify=true
      changed_when: false
      no_log: true
      tags: [always]

    - name: Template startup.sh for Jupyter images
      ansible.builtin.template:
        src: "{{ local_base_images_dir }}/startup.sh.j2"
        dest: "{{ base_images_dir }}/startup.sh"
      tags: [always]

    # ==========================================================================
    # ML-GPU IMAGE (base image for others)
    # Usage: --tags ml-gpu
    # ==========================================================================
    - name: Template tk-jupyter-ml-gpu Containerfile
      ansible.builtin.template:
        src: "{{ local_base_images_dir }}/tk-jupyter-ml-gpu.Containerfile.j2"
        dest: "{{ temp_containerfiles_dir.path }}/tk-jupyter-ml-gpu.Containerfile"
      tags: [ml-gpu]

    # Use CACHE_BUST arg to invalidate only the tk-ai-extension layer (last layers in Containerfile)
    # All base packages (PyTorch, transformers, etc.) will use cached layers for fast rebuilds
    - name: Build tk-jupyter-ml-gpu image
      ansible.builtin.shell: |
        podman build --platform {{ container_build_platforms | default('linux/amd64,linux/arm64') }} \
                     --tls-verify=true \
                     --build-arg CACHE_BUST=$(date +%s) \
                     -t {{ harbor_registry }}/library/tk-jupyter-ml-gpu:latest \
                     -f {{ temp_containerfiles_dir.path }}/tk-jupyter-ml-gpu.Containerfile \
                     {{ base_images_dir }}
      register: tk_jupyter_ml_gpu_build
      changed_when: true
      tags: [ml-gpu]

    - name: Push tk-jupyter-ml-gpu image
      ansible.builtin.shell: |
        podman push --tls-verify=true {{ harbor_registry }}/library/tk-jupyter-ml-gpu:latest
      register: tk_jupyter_ml_gpu_push
      changed_when: tk_jupyter_ml_gpu_push.rc == 0
      failed_when: tk_jupyter_ml_gpu_push.rc != 0
      retries: 2
      delay: 10
      tags: [ml-gpu]

    # ==========================================================================
    # FINE-TUNING IMAGE (depends on ml-gpu)
    # Usage: --tags fine-tuning
    # ==========================================================================
    - name: Template tk-jupyter-fine-tuning Containerfile
      ansible.builtin.template:
        src: "{{ local_base_images_dir }}/tk-jupyter-fine-tuning.Containerfile.j2"
        dest: "{{ temp_containerfiles_dir.path }}/tk-jupyter-fine-tuning.Containerfile"
      tags: [fine-tuning]

    - name: Build tk-jupyter-fine-tuning image
      ansible.builtin.shell: |
        podman build --platform {{ container_build_platforms | default('linux/amd64,linux/arm64') }} \
                     --tls-verify=true \
                     -t {{ harbor_registry }}/library/tk-jupyter-fine-tuning:latest \
                     -f {{ temp_containerfiles_dir.path }}/tk-jupyter-fine-tuning.Containerfile \
                     {{ base_images_dir }}
      register: tk_jupyter_fine_tuning_build
      changed_when: true
      tags: [fine-tuning]

    - name: Push tk-jupyter-fine-tuning image
      ansible.builtin.shell: |
        podman push --tls-verify=true {{ harbor_registry }}/library/tk-jupyter-fine-tuning:latest
      register: tk_jupyter_fine_tuning_push
      changed_when: tk_jupyter_fine_tuning_push.rc == 0
      failed_when: tk_jupyter_fine_tuning_push.rc != 0
      retries: 2
      delay: 10
      tags: [fine-tuning]

    # ==========================================================================
    # AGENT-DEV IMAGE (depends on ml-gpu)
    # Usage: --tags agent-dev
    # ==========================================================================
    - name: Template tk-jupyter-agent-dev Containerfile
      ansible.builtin.template:
        src: "{{ local_base_images_dir }}/tk-jupyter-agent-dev.Containerfile.j2"
        dest: "{{ temp_containerfiles_dir.path }}/tk-jupyter-agent-dev.Containerfile"
      tags: [agent-dev]

    - name: Build tk-jupyter-agent-dev image
      ansible.builtin.shell: |
        podman build --platform {{ container_build_platforms | default('linux/amd64,linux/arm64') }} \
                     --tls-verify=true \
                     -t {{ harbor_registry }}/library/tk-jupyter-agent-dev:latest \
                     -f {{ temp_containerfiles_dir.path }}/tk-jupyter-agent-dev.Containerfile \
                     {{ base_images_dir }}
      register: tk_jupyter_agent_dev_build
      changed_when: true
      tags: [agent-dev]

    - name: Push tk-jupyter-agent-dev image
      ansible.builtin.shell: |
        podman push --tls-verify=true {{ harbor_registry }}/library/tk-jupyter-agent-dev:latest
      register: tk_jupyter_agent_dev_push
      changed_when: tk_jupyter_agent_dev_push.rc == 0
      failed_when: tk_jupyter_agent_dev_push.rc != 0
      retries: 2
      delay: 10
      tags: [agent-dev]

    # ==========================================================================
    # CLEANUP (always runs)
    # ==========================================================================
    - name: Clean up temp containerfiles directory
      ansible.builtin.file:
        path: "{{ temp_containerfiles_dir.path }}"
        state: absent
      when: temp_containerfiles_dir.path is defined
      tags: [always]

    # ==========================================================================
    # MANIFEST & COMPLETION (only when building all images)
    # ==========================================================================
    - name: Create manifest for Jupyter images
      include_role:
        name: container_deployment/image_manifest
      vars:
        manifest_images:
          - destination: "{{ harbor_registry }}/library/tk-jupyter-ml-gpu:latest"
            source: "custom-build"
            description: "Jupyter ML Development with CUDA 12.6 and Thinkube services (works on CPU too)"
            metadata:
              purpose: "jupyter"
              display_name: "ML Development"
              default: true
              base_image: "cuda:12.6.0-cudnn-runtime-ubuntu24.04"
              packages: "torch transformers datasets accelerate pandas scikit-learn"
              services: "postgresql valkey qdrant opensearch mlflow seaweedfs weaviate litellm"
          - destination: "{{ harbor_registry }}/library/tk-jupyter-fine-tuning:latest"
            source: "custom-build"
            description: "Jupyter Fine-Tuning Lab with Unsloth and QLoRA"
            metadata:
              purpose: "jupyter"
              display_name: "Fine-Tuning Lab"
              default: false
              requires_gpu: true
              base_image: "tk-jupyter-ml-gpu:latest"
              packages: "unsloth bitsandbytes peft trl"
          - destination: "{{ harbor_registry }}/library/tk-jupyter-agent-dev:latest"
            source: "custom-build"
            description: "Jupyter Agent Development with LangChain and CrewAI"
            metadata:
              purpose: "jupyter"
              display_name: "Agent Development"
              default: false
              base_image: "tk-jupyter-ml-gpu:latest"
              packages: "langchain crewai faiss"
        manifest_category: "user"
        manifest_source: "built"
        manifest_namespace: "registry"
      tags: [ml-gpu, fine-tuning, agent-dev]

    - name: Display completion message
      ansible.builtin.debug:
        msg: |

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          âœ… Jupyter Images Built and Pushed Successfully
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          TK Jupyter ML GPU: {{ harbor_registry }}/library/tk-jupyter-ml-gpu:latest
          TK Jupyter Fine-Tuning: {{ harbor_registry }}/library/tk-jupyter-fine-tuning:latest
          TK Jupyter Agent Dev: {{ harbor_registry }}/library/tk-jupyter-agent-dev:latest

          All images include Thinkube services integration:
          - PostgreSQL, Valkey (Redis), Qdrant, Chroma, Weaviate
          - OpenSearch, MLflow, SeaweedFS, LiteLLM
          - NATS, ClickHouse, Argo Workflows, Gitea

          Base image (ML GPU):
          - PyTorch + CUDA 12.6, transformers, datasets, accelerate
          - Pandas, scikit-learn, matplotlib, seaborn, plotly
          - Works on CPU nodes (GPU optional, controlled by Kubernetes)

          Specialized packages:
          - Fine-Tuning: Unsloth, QLoRA, bitsandbytes, PEFT, TRL
          - Agent Dev: LangChain, CrewAI, FAISS

          Run this playbook separately from JupyterHub deployment
          for faster iteration during image development.
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      tags: [ml-gpu, fine-tuning, agent-dev]
