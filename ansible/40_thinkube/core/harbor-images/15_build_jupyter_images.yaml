# Copyright 2025 Alejandro Martínez Corriá and the Thinkube contributors
# SPDX-License-Identifier: Apache-2.0

---
# ansible/40_thinkube/core/harbor/15_build_jupyter_images.yaml
# Description:
#   Build and push tk-jupyter-base image to Harbor library project.
#   This minimal image uses NVIDIA PyTorch with Flash Attention 2 support.
#   ML packages are installed in persistent venvs on JuiceFS.
#
# Requirements:
#   - Harbor registry deployed and accessible
#   - Podman installed on the k8s-snap control plane node
#   - Harbor admin credentials
#   - NVIDIA PyTorch image mirrored to Harbor (13_mirror_public_images.yaml)
#
# Usage:
#   cd ~/thinkube
#   ./scripts/tk_ansible ansible/40_thinkube/core/harbor-images/15_build_jupyter_images.yaml
#
# Architecture:
#   tk-jupyter-base is a minimal JupyterLab image based on NVIDIA PyTorch.
#   ML packages (transformers, unsloth, langchain, etc.) are installed in
#   persistent venvs on JuiceFS. Users select kernels in JupyterLab.
#   See 13_bootstrap_venvs.yaml for venv creation.
#
# Variables from inventory:
#   - harbor_registry: Harbor registry hostname
#   - admin_password: Admin password from environment
#
# Dependencies:
#   - CORE-008: Harbor deployed
#   - 13_mirror_public_images.yaml: NVIDIA PyTorch image mirrored

- name: Build and Push Jupyter Base Image to Harbor
  hosts: k8s_control_plane
  gather_facts: true

  vars:
    local_base_images_dir: "{{ playbook_dir }}/base-images"
    base_images_dir: "/tmp/harbor-base-images"
    admin_password: "{{ lookup('env', 'ADMIN_PASSWORD') | default(lookup('env', 'ANSIBLE_BECOME_PASSWORD'), true) }}"

  tasks:
    # ==========================================================================
    # SETUP
    # ==========================================================================
    - name: Create build context directory
      ansible.builtin.file:
        path: "{{ base_images_dir }}"
        state: directory
        mode: '0755'

    - name: Create temp directory for templated Containerfiles
      ansible.builtin.tempfile:
        state: directory
        suffix: jupyter-containerfiles
      register: temp_containerfiles_dir

    - name: Template Thinkube environment file for Jupyter images
      ansible.builtin.template:
        src: "{{ local_base_images_dir }}/thinkube_env.j2"
        dest: "{{ base_images_dir }}/.thinkube_env"
        mode: '0644'

    - name: Template iPython startup script for environment loading
      ansible.builtin.template:
        src: "{{ local_base_images_dir }}/templates/00-thinkube-env.py"
        dest: "{{ base_images_dir }}/00-thinkube-env.py"
        mode: '0644'

    - name: Template Jupyter test notebook
      ansible.builtin.template:
        src: "{{ local_base_images_dir }}/templates/test-thinkube-services.ipynb.j2"
        dest: "{{ base_images_dir }}/test-thinkube-services.ipynb"
        mode: '0644'

    - name: Copy Thinkube icons to build context
      ansible.builtin.copy:
        src: "{{ local_base_images_dir }}/icons/"
        dest: "{{ base_images_dir }}/icons/"
        mode: '0644'

    - name: Copy Jupyter flavor validation helper
      ansible.builtin.copy:
        src: "{{ local_base_images_dir }}/files/check_jupyter_flavor.py"
        dest: "{{ base_images_dir }}/check_jupyter_flavor.py"
        mode: '0644'

    - name: Copy Thinkube models helper
      ansible.builtin.copy:
        src: "{{ local_base_images_dir }}/files/thinkube_models.py"
        dest: "{{ base_images_dir }}/thinkube_models.py"
        mode: '0644'

    - name: Login to Harbor
      ansible.builtin.shell: |
        echo {{ admin_password }} | podman login {{ harbor_registry }} -u admin --password-stdin --tls-verify=true
      changed_when: false
      no_log: true

    - name: Template startup.sh for Jupyter images
      ansible.builtin.template:
        src: "{{ local_base_images_dir }}/startup.sh.j2"
        dest: "{{ base_images_dir }}/startup.sh"

    # ==========================================================================
    # BUILD tk-jupyter-base
    # ==========================================================================
    - name: Template tk-jupyter-base Containerfile
      ansible.builtin.template:
        src: "{{ local_base_images_dir }}/tk-jupyter-base.Containerfile.j2"
        dest: "{{ temp_containerfiles_dir.path }}/tk-jupyter-base.Containerfile"

    - name: Build tk-jupyter-base image
      ansible.builtin.shell: |
        podman build --platform linux/arm64 \
                     --tls-verify=true \
                     --build-arg CACHE_BUST=$(date +%s) \
                     -t {{ harbor_registry }}/library/tk-jupyter-base:latest \
                     -f {{ temp_containerfiles_dir.path }}/tk-jupyter-base.Containerfile \
                     {{ base_images_dir }}
      register: tk_jupyter_base_build
      changed_when: true

    - name: Push tk-jupyter-base image
      ansible.builtin.shell: |
        podman push --tls-verify=true {{ harbor_registry }}/library/tk-jupyter-base:latest
      register: tk_jupyter_base_push
      changed_when: tk_jupyter_base_push.rc == 0
      failed_when: tk_jupyter_base_push.rc != 0
      retries: 2
      delay: 10

    # ==========================================================================
    # CLEANUP
    # ==========================================================================
    - name: Clean up temp containerfiles directory
      ansible.builtin.file:
        path: "{{ temp_containerfiles_dir.path }}"
        state: absent
      when: temp_containerfiles_dir.path is defined

    # ==========================================================================
    # MANIFEST
    # ==========================================================================
    - name: Create manifest for tk-jupyter-base
      include_role:
        name: container_deployment/image_manifest
      vars:
        manifest_images:
          - destination: "{{ harbor_registry }}/library/tk-jupyter-base:latest"
            source: "custom-build"
            description: "Jupyter Base - NVIDIA PyTorch with FA2 support. ML packages in venvs."
            metadata:
              purpose: "jupyter"
              display_name: "Jupyter Base"
              default: true
              base_image: "pytorch:25.04-py3"
              packages: "jupyterlab ipykernel (ML packages in persistent venvs)"
              services: "postgresql valkey qdrant opensearch mlflow seaweedfs weaviate litellm"
        manifest_category: "user"
        manifest_source: "built"
        manifest_namespace: "registry"

    - name: Display completion message
      ansible.builtin.debug:
        msg: |

          ════════════════════════════════════════════════════════
          tk-jupyter-base Built and Pushed Successfully
          ════════════════════════════════════════════════════════

          Image: {{ harbor_registry }}/library/tk-jupyter-base:latest

          Base: NVIDIA PyTorch 25.04 with Flash Attention 2 support
          User: thinkube (UID 1000)

          Includes:
          - JupyterLab, JupyterHub, ipykernel
          - Claude Code CLI, openai-harmony
          - Thinkube service discovery

          ML packages are NOT baked into this image.
          They are installed in persistent venvs on JuiceFS.

          Next steps:
          1. Deploy JupyterHub: 11_deploy.yaml
          2. Bootstrap venvs: 13_bootstrap_venvs.yaml -l tkspark

          Users select kernels (ml-gpu, fine-tuning, agent-dev)
          in JupyterLab instead of selecting images at spawn.
          ════════════════════════════════════════════════════════
