# Copyright 2025 Alejandro Mart√≠nez Corri√° and the Thinkube contributors
# SPDX-License-Identifier: Apache-2.0

# Jupyter Agent Development - AI agent development environment
# Base: jupyter-ml-gpu (PyTorch + CUDA + ML libraries)
# Includes: AG2, LangGraph, OpenAI Agents SDK, FAISS for agent development

FROM {{ harbor_registry }}/library/tk-jupyter-ml-gpu:latest

USER root

# Install LangChain 1.x (latest stable)
RUN pip install --no-cache-dir \
    langchain==1.1.3 \
    langchain-core==1.1.3 \
    langchain-community==0.4.1 \
    langchain-openai==1.1.1

# Install AG2 (formerly AutoGen) - most agnostic multi-agent framework
# Apache 2.0 license, community-driven, native tool calling
RUN pip install --no-cache-dir \
    "ag2[openai]==0.10.2"

# Install LangGraph - graph-based workflow orchestration
RUN pip install --no-cache-dir \
    langgraph==0.4.1

# Install OpenAI Agents SDK - lightweight multi-agent framework
RUN pip install --no-cache-dir \
    openai-agents==0.6.2

# Install CrewAI - multi-agent framework (works with external APIs like Claude/GPT-4)
# Note: CrewAI uses ReAct prompting, not native tool calling - won't work with GPT-OSS
RUN pip install --no-cache-dir \
    crewai==1.7.0 \
    crewai-tools==1.7.0

# Install OpenTelemetry for Langfuse integration (OTEL endpoint)
# Note: CrewAI 1.3.0 already includes opentelemetry packages, but we pin versions for consistency
RUN pip install --no-cache-dir \
    opentelemetry-sdk==1.39.0 \
    opentelemetry-exporter-otlp==1.39.0 \
    opentelemetry-api==1.39.0

# Install OpenLIT for automatic AG2/AutoGen instrumentation with Langfuse
# See: https://docs.ag2.ai/latest/docs/use-cases/notebooks/notebooks/agentchat_openlit/
# IMPORTANT: Use --no-deps to prevent openlit from downgrading LangChain to 0.3.x
# (openlit caps langchain<0.4.0 but we need LangChain 1.x for ModelProfileRegistry)
RUN pip install --no-cache-dir --no-deps openlit && \
    pip install --no-cache-dir opentelemetry-api opentelemetry-sdk opentelemetry-exporter-otlp tiktoken

# Install FAISS for vector similarity search
RUN pip install --no-cache-dir \
    faiss-cpu==1.12.0

# All Thinkube service clients and chromadb are inherited from base image

# Override Jupyter flavor identifier for agent-dev
RUN echo "agent-dev" > /home/jovyan/.jupyter_flavor && \
    chown $NB_UID:$NB_GID /home/jovyan/.jupyter_flavor

# Note: ENTRYPOINT and startup script are inherited from base image
# But we need to override with our image name
COPY startup.sh /usr/local/bin/startup.sh
RUN chmod +x /usr/local/bin/startup.sh
USER $NB_UID

# ü§ñ AI-assisted