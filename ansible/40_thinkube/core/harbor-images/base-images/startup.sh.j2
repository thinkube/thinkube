#!/bin/bash
# Copyright 2025 Alejandro Martínez Corriá and the Thinkube contributors
# SPDX-License-Identifier: Apache-2.0

# Simplified directory structure (JupyterHub mounts these):
#   /home/jovyan/thinkube/templates/  - Read-only templates (cloned fresh each pod)
#   /home/jovyan/thinkube/icons/      - Thinkube icons (ConfigMap mount)
#   /home/jovyan/thinkube/notebooks/  - User's persistent work
#   /home/jovyan/thinkube/mlflow/     - Shared MLflow artifacts
TEMPLATES_DIR="/home/jovyan/thinkube/templates"

# Ensure persistent notebooks directory exists
mkdir -p /home/jovyan/thinkube/notebooks

# Setup iPython startup directory for environment variable loading
echo "Setting up iPython environment loader..."
mkdir -p /home/jovyan/.ipython/profile_default/startup
if [ ! -f "/home/jovyan/.ipython/profile_default/startup/00-thinkube-env.py" ]; then
  cp /opt/thinkube/00-thinkube-env.py /home/jovyan/.ipython/profile_default/startup/
  echo "  ✓ iPython startup script installed"
else
  echo "  ✓ iPython startup script already present"
fi

# Copy test notebook to notebooks directory if not present
if [ ! -f "/home/jovyan/thinkube/notebooks/test-thinkube-services.ipynb" ]; then
  echo "Copying Thinkube services test notebook..."
  cp /opt/thinkube/test-thinkube-services.ipynb /home/jovyan/thinkube/notebooks/
  echo "  ✓ Test notebook available at: ~/thinkube/notebooks/test-thinkube-services.ipynb"
fi

# Icons are now mounted at /home/jovyan/thinkube/icons/ via ConfigMap
# No need to copy from image - just verify they're available
if [ -d "/home/jovyan/thinkube/icons" ]; then
  echo "  ✓ Icons available at: ~/thinkube/icons/"
fi

# Create CLAUDE.md if it doesn't exist (context for Claude AI)
if [ ! -f "/home/jovyan/thinkube/notebooks/CLAUDE.md" ]; then
  if [ -f "$TEMPLATES_DIR/CLAUDE.md" ]; then
    echo "Creating CLAUDE.md context file for AI assistant..."
    cp "$TEMPLATES_DIR/CLAUDE.md" /home/jovyan/thinkube/notebooks/CLAUDE.md
  else
    echo "  Note: CLAUDE.md not found in templates"
  fi
fi

# Check templates directory is available (mounted by JupyterHub)
# Templates are cloned by JupyterHub init container and copied to examples/
if [ -d "$TEMPLATES_DIR" ]; then
  echo "  ✓ Templates available at: ~/thinkube/templates/"
fi

# Ensure PATH includes user's local bin where jupyterhub-singleuser is installed
export PATH="/home/jovyan/.local/bin:${PATH}"

# Start whatever command was passed
exec "$@"