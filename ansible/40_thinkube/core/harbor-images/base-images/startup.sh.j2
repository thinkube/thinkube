#!/bin/bash
# Copyright 2025 Alejandro Martínez Corriá and the Thinkube contributors
# SPDX-License-Identifier: Apache-2.0

# Image identifier for organizing examples
IMAGE_NAME="{{ image_name }}"

# New simplified directory structure (JupyterHub mounts these):
#   /home/jovyan/thinkube/templates/  - Read-only templates (cloned fresh each pod)
#   /home/jovyan/thinkube/icons/      - Thinkube icons (ConfigMap mount)
#   /home/jovyan/thinkube/notebooks/  - User's persistent work
#   /home/jovyan/thinkube/mlflow/     - Shared MLflow artifacts
TEMPLATES_DIR="/home/jovyan/thinkube/templates"

# Ensure persistent notebooks directory exists
mkdir -p /home/jovyan/thinkube/notebooks

# Setup iPython startup directory for environment variable loading
echo "Setting up iPython environment loader..."
mkdir -p /home/jovyan/.ipython/profile_default/startup
if [ ! -f "/home/jovyan/.ipython/profile_default/startup/00-thinkube-env.py" ]; then
  cp /opt/thinkube/00-thinkube-env.py /home/jovyan/.ipython/profile_default/startup/
  echo "  ✓ iPython startup script installed"
else
  echo "  ✓ iPython startup script already present"
fi

# Copy test notebook to notebooks directory if not present
if [ ! -f "/home/jovyan/thinkube/notebooks/test-thinkube-services.ipynb" ]; then
  echo "Copying Thinkube services test notebook..."
  cp /opt/thinkube/test-thinkube-services.ipynb /home/jovyan/thinkube/notebooks/
  echo "  ✓ Test notebook available at: ~/thinkube/notebooks/test-thinkube-services.ipynb"
fi

# Icons are now mounted at /home/jovyan/thinkube/icons/ via ConfigMap
# No need to copy from image - just verify they're available
if [ -d "/home/jovyan/thinkube/icons" ]; then
  echo "  ✓ Icons available at: ~/thinkube/icons/"
fi

# Create CLAUDE.md if it doesn't exist (context for Claude AI)
if [ ! -f "/home/jovyan/thinkube/notebooks/CLAUDE.md" ]; then
  if [ -f "$TEMPLATES_DIR/CLAUDE.md.template" ]; then
    echo "Creating CLAUDE.md context file for AI assistant..."
    cp "$TEMPLATES_DIR/CLAUDE.md.template" /home/jovyan/thinkube/notebooks/CLAUDE.md
  else
    echo "  Note: CLAUDE.md.template not found in templates"
  fi
fi

# Check templates directory is available (mounted by JupyterHub)
if [ ! -d "$TEMPLATES_DIR" ]; then
  echo "WARNING: Templates directory not found at $TEMPLATES_DIR"
  echo "This may be a deployment issue - templates should be mounted by JupyterHub"
  # Don't fail - allow startup to continue, user can still work
fi

# Determine which examples to copy based on image type
EXAMPLE_DIRS="common"  # Always include common

case "$IMAGE_NAME" in
  tk-jupyter-ml-gpu)
    EXAMPLE_DIRS="common ml-gpu"
    ;;
  tk-jupyter-fine-tuning)
    EXAMPLE_DIRS="common fine-tuning"
    ;;
  tk-jupyter-agent-dev)
    EXAMPLE_DIRS="common agent-dev"
    ;;
  *)
    echo "  Note: Image type $IMAGE_NAME, using common examples only"
    ;;
esac

# Copy examples to image-specific folder (allows multiple images to coexist)
# Only copy if templates exist and not already copied
if [ -d "$TEMPLATES_DIR" ] && [ ! -f "/home/jovyan/thinkube/notebooks/examples/${IMAGE_NAME}/.copied" ]; then
  echo "Copying editable example notebooks to examples/${IMAGE_NAME}/..."
  mkdir -p "/home/jovyan/thinkube/notebooks/examples/${IMAGE_NAME}"

  for dir in $EXAMPLE_DIRS; do
    if [ -d "$TEMPLATES_DIR/$dir" ]; then
      echo "  - Copying $dir examples..."
      mkdir -p "/home/jovyan/thinkube/notebooks/examples/${IMAGE_NAME}/$dir"
      cp -r "$TEMPLATES_DIR/$dir"/* "/home/jovyan/thinkube/notebooks/examples/${IMAGE_NAME}/$dir/" 2>/dev/null || true
    else
      echo "  - Note: Directory $TEMPLATES_DIR/$dir not found, skipping"
    fi
  done

  touch "/home/jovyan/thinkube/notebooks/examples/${IMAGE_NAME}/.copied"
  echo "Examples copied successfully"
fi

# Ensure PATH includes user's local bin where jupyterhub-singleuser is installed
export PATH="/home/jovyan/.local/bin:${PATH}"

# Start whatever command was passed
exec "$@"