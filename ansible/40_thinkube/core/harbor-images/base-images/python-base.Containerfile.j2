# Copyright 2025 Alejandro Martínez Corriá and the Thinkube contributors
# SPDX-License-Identifier: Apache-2.0

# Shared Python base image with common dependencies
FROM {{ harbor_registry }}/library/python:3.12-slim

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    git \
    curl \
    jq \
    postgresql-client \
    # Deployment and debugging tools
    openssh-client \
    sshpass \
    dnsutils \
    iputils-ping \
    net-tools \
    telnet \
    traceroute \
    nmap \
    netcat-openbsd \
    iproute2 \
    tcpdump \
    vim-tiny \
    podman \
    fuse-overlayfs \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Create thinkube user with UID 1000 (matches securityContext runAsUser)
# This is required for SSH to work when container runs as UID 1000
RUN groupadd -g 1000 thinkube && \
    useradd -u 1000 -g 1000 -m -s /bin/bash thinkube && \
    mkdir -p /home/thinkube/.ssh && \
    chown -R thinkube:thinkube /home/thinkube

# Configure podman for rootless operation in container
RUN mkdir -p /etc/containers && \
    echo '[engine]' > /etc/containers/containers.conf && \
    echo 'cgroup_manager = "cgroupfs"' >> /etc/containers/containers.conf && \
    echo 'events_logger = "file"' >> /etc/containers/containers.conf && \
    echo '[engine.volume_plugins]' >> /etc/containers/containers.conf && \
    echo '[storage]' > /etc/containers/storage.conf && \
    echo 'driver = "overlay"' >> /etc/containers/storage.conf && \
    echo 'runroot = "/run/containers/storage"' >> /etc/containers/storage.conf && \
    echo 'graphroot = "/var/lib/containers/storage"' >> /etc/containers/storage.conf && \
    echo '[storage.options]' >> /etc/containers/storage.conf && \
    echo '[storage.options.overlay]' >> /etc/containers/storage.conf && \
    echo 'mount_program = "/usr/bin/fuse-overlayfs"' >> /etc/containers/storage.conf && \
    touch /etc/containers/registries.conf

# Install Python packages for thinkube-control backend
RUN pip install --no-cache-dir \
    # Web framework dependencies
    uvicorn==0.32.1 \
    fastapi==0.115.5 \
    pydantic==2.11.7 \
    pydantic-settings==2.6.1 \
    # Database
    sqlalchemy==2.0.36 \
    asyncpg==0.30.0 \
    alembic==1.14.0 \
    psycopg2-binary==2.9.10 \
    # HTTP clients
    httpx==0.28.1 \
    requests==2.32.3 \
    aiohttp==3.10.0 \
    # Testing dependencies
    pytest==8.3.4 \
    pytest-asyncio==0.25.0 \
    pytest-cov==6.0.0 \
    faker==20.1.0 \
    # Code quality
    flake8==7.1.1 \
    black==24.10.0 \
    isort==5.13.0 \
    # Utilities
    python-jose[cryptography]==3.3.0 \
    PyJWT==2.10.1 \
    python-multipart==0.0.20 \
    cryptography==44.0.0 \
    kubernetes==34.1.0 \
    kubernetes-asyncio==33.3.0 \
    websockets==15.0.1 \
    pyyaml==6.0.2 \
    MarkupSafe==3.0.2 \
    boto3==1.35.76 \
    # MLflow for model registry
    mlflow==3.6.0 \
    # Workflow orchestration
    hera-workflows>=5.19.0 \
    # MCP support (fastapi-mcp 0.4.0 requires mcp>=1.12.0)
    mcp==1.20.0 \
    fastapi-mcp==0.4.0 \
    sse-starlette>=2.1.3 \
    starlette==0.41.3 \
    # Deployment tools
    ansible \
    "copier>=9.4"

# Set Python environment variables
ENV PYTHONPATH=/app \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=0 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

WORKDIR /app