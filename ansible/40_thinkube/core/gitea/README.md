# Gitea - Git Service for Thinkube

Gitea provides Git repository hosting for the Thinkube GitOps workflow, enabling domain-specific deployments while maintaining clean templates for upstream contributions.

## Overview

- **Component**: CORE-014 (Gitea)
- **Namespace**: gitea
- **Service URL**: https://git.{{ domain_name }}
- **Authentication**: Keycloak OAuth2/OIDC
- **Database**: PostgreSQL (shared)
- **Storage**: PVC for repositories

## Purpose in Thinkube

Gitea solves a critical problem in multi-domain deployments:
1. **Templates** in GitHub use variables like `{{ domain_name }}`
2. **Deployments** need actual values like `registry.thinkube.com`
3. **Gitea** hosts the processed manifests with domain-specific values
4. **ArgoCD** deploys from Gitea, not GitHub

## GitOps Workflow

```
GitHub (templates) → Process → Gitea (manifests) → ArgoCD
     ↑                              ↓
     └──── Contribute back ─────────┘
           (templates only)
```

### Development Cycle

1. **Deploy Application**
   - Playbook clones from GitHub
   - Processes templates with domain values
   - Pushes to Gitea with git hooks installed

2. **Develop in Gitea**
   - Edit `.jinja` template files
   - Commit changes (hook auto-processes)
   - Push to Gitea
   - ArgoCD deploys changes

3. **Contribute to GitHub**
   - Run `./prepare-for-github.sh`
   - Push branch to GitHub
   - Only templates are shared

## Deployment

### Step 1: Deploy Gitea
```bash
cd ~/thinkube
./scripts/run_ansible.sh ansible/40_thinkube/core/gitea/10_deploy.yaml
```

This playbook:
- Creates admin user automatically
- Configures OAuth2 with Keycloak
- Generates API token
- Sets up webhook and timeout configurations
- Creates `thinkube-deployments` organization

### Step 2: Configure Organizations (Optional)
```bash
./scripts/run_ansible.sh ansible/40_thinkube/core/gitea/15_configure.yaml
```

This creates additional organizations if needed.

### Step 3: Test Deployment
```bash
./scripts/run_ansible.sh ansible/40_thinkube/core/gitea/18_test.yaml
```

This verifies:
- Gitea core functionality
- Database connectivity
- Keycloak OAuth integration
- API access
- Webhook configuration (if Argo Events is deployed)

### Step 4: Rollback (if needed)
```bash
./scripts/run_ansible.sh ansible/40_thinkube/core/gitea/19_rollback.yaml
```

## Configuration Details

### Unattended Installation
The deployment is fully automated:
- **Admin User**: Created via environment variables
- **OAuth2**: Configured with Keycloak automatically
- **API Token**: Generated and stored in `gitea-admin-token` secret
- **Webhooks**: Configured to allow `*.{{ domain_name }}`

### Template Processing
Applications deployed to Gitea include:
- **Git hooks**: Auto-process `.jinja` files on commit
- **Helper scripts**:
  - `./reprocess-templates.sh` - Manual template processing
  - `./prepare-for-github.sh` - Clean for upstream contribution
  - `./install-hooks.sh` - Reinstall git hooks if needed

### Auto-Generated Files
Processed files include headers:
```yaml
# AUTO-GENERATED FILE - DO NOT EDIT DIRECTLY
# This file is automatically generated from k8s/deployment.yaml.jinja
# Any changes made directly to this file will be lost on next commit
# To make changes, edit the template file and commit
# Generated for domain: thinkube.com
```

## Repository Structure

```
gitea/
├── thinkube-deployments/           # Processed manifests for ArgoCD
│   ├── thinkube-control-deployment/
│   │   ├── k8s/                   # Processed YAML files
│   │   ├── templates/             # Original .jinja files
│   │   ├── .git-hooks/            # Auto-processing hooks
│   │   ├── DEPLOYMENT_INFO.yaml   # Metadata
│   │   └── DEVELOPMENT.md         # Workflow documentation
│   └── other-app-deployment/
└── thinkube-development/           # (Future: development repos)
```

## Integration Points

- **Keycloak**: OAuth2 authentication provider
- **PostgreSQL**: Database backend
- **ArgoCD**: Watches Gitea repositories for deployments
- **Harbor**: Container registry referenced in manifests
- **Argo Events**: Webhook endpoint for CI/CD triggers

## Developer Workflow

### Starting Development
1. Application deployed via Ansible playbook
2. Repository created in Gitea with hooks installed
3. Clone from Gitea to start development

### Making Changes
1. Edit `.jinja` template files (not processed `.yaml`)
2. Commit changes - hook processes automatically
3. Push to Gitea - ArgoCD deploys

### Contributing Upstream
1. Run `./prepare-for-github.sh` to remove processed files
2. Add GitHub remote: `git remote add upstream https://github.com/...`
3. Push feature branch: `git push upstream feature-branch`
4. Create PR on GitHub

## CI/CD Integration with Argo Events

### Automatic Webhook Configuration

When repositories are created using the `git_push` role (used by all deployment playbooks), webhooks are automatically configured if Argo Events is available. This happens transparently during repository creation - no manual configuration needed!

When Argo Events is deployed, pushes to Gitea repositories trigger Argo Workflows:
1. Push to Gitea repository
2. Gitea sends webhook to `https://argo-events.{{ domain_name }}/gitea`
3. Argo Events EventSource receives the webhook
4. Sensor triggers an Argo Workflow with repository information
5. Workflow can build, test, and deploy the application

### Workflow Parameters
The triggered workflow receives:
- `repo-name`: Repository name
- `repo-url`: Clone URL
- `commit-sha`: Commit hash
- `branch`: Branch reference

### Example Workflow Template
```yaml
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: gitea-build-template
spec:
  entrypoint: build
  arguments:
    parameters:
    - name: repo-url
    - name: commit-sha
  templates:
  - name: build
    steps:
    - - name: clone
        template: git-clone
    - - name: build-image
        template: docker-build
    - - name: push-to-harbor
        template: harbor-push
```

## API Access

The admin API token is automatically generated:
```bash
# Get token from Kubernetes secret
kubectl get secret -n gitea gitea-admin-token -o jsonpath='{.data.token}' | base64 -d

# Use in API calls
curl -H "Authorization: token YOUR_TOKEN" https://git.thinkube.com/api/v1/user
```

## Troubleshooting

### OAuth2 Login Issues
- Check Keycloak client configuration
- Verify OAuth2 provider in Gitea: `kubectl exec -n gitea deployment/gitea -- su git -c "gitea admin auth list"`

### Template Processing Issues
- Check git hooks are installed: `ls -la .git/hooks/pre-commit`
- Run manual processing: `./reprocess-templates.sh`
- Verify domain values in processed files

### Repository Creation Issues
- Check admin token exists: `kubectl get secret -n gitea gitea-admin-token`
- Verify organization exists in Gitea UI
- Check Ansible logs for git_push role errors

### Webhook Issues
- Verify Argo Events is deployed: `kubectl get svc -n argo gitea-webhook-eventsource`
- Check webhook configuration: Use Gitea API to list repository webhooks
- Test webhook endpoint: `curl -I https://argo-events.{{ domain_name }}/gitea`