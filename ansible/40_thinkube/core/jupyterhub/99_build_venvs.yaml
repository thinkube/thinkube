# Copyright 2025 Alejandro Martínez Corriá and the Thinkube contributors
# SPDX-License-Identifier: Apache-2.0
#
# ansible/40_thinkube/core/jupyterhub/99_build_venvs.yaml
#
# PURPOSE:
#   Build pre-packaged Python virtualenvs for JupyterHub and upload to GitHub.
#   Fully automated - waits for build completion and uploads to GitHub releases.
#
# REQUIREMENTS:
#   - tk-jupyter-base image built and pushed to Harbor
#   - kubectl access to the cluster
#   - GPU node available for the target architecture
#   - gh CLI authenticated (gh auth login)
#
# USAGE:
#   ./scripts/tk_ansible ansible/40_thinkube/core/jupyterhub/99_build_venvs.yaml
#
# OUTPUT:
#   Venv tarballs uploaded to GitHub release at:
#   https://github.com/thinkube/thinkube-venvs/releases/tag/{version}

---
- name: Build and Upload Jupyter Virtualenvs
  hosts: k8s_control_plane
  gather_facts: false

  vars:
    venvs_version: "v0.1.0"
    build_namespace: "jupyterhub"
    job_name: "venvs-builder"
    github_repo: "thinkube/thinkube-venvs"
    local_output_dir: "/tmp/venvs-output-{{ ansible_date_time.epoch | default(lookup('pipe', 'date +%s')) }}"

  tasks:
    - name: Display build info
      ansible.builtin.debug:
        msg: |
          ════════════════════════════════════════════════════════════════
          Building Jupyter Venvs {{ venvs_version }}
          ════════════════════════════════════════════════════════════════

          This playbook will:
          1. Build venvs in a K8s Job (30-60 minutes)
          2. Copy tarballs from the pod
          3. Upload to GitHub release automatically

          GitHub repo: {{ github_repo }}

    - name: Check gh CLI is authenticated
      ansible.builtin.command: gh auth status
      register: gh_auth
      failed_when: gh_auth.rc != 0
      changed_when: false

    - name: Copy build script to ConfigMap
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: venvs-build-script
            namespace: "{{ build_namespace }}"
          data:
            build-venvs.sh: |
              {{ lookup('file', playbook_dir + '/scripts/build-venvs.sh') | indent(14) }}

    - name: Delete existing build job if present
      kubernetes.core.k8s:
        state: absent
        api_version: batch/v1
        kind: Job
        name: "{{ job_name }}"
        namespace: "{{ build_namespace }}"
        wait: true
        wait_timeout: 60
      ignore_errors: true

    - name: Create venvs build job
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: batch/v1
          kind: Job
          metadata:
            name: "{{ job_name }}"
            namespace: "{{ build_namespace }}"
          spec:
            ttlSecondsAfterFinished: 3600  # Keep for 1 hour after completion
            backoffLimit: 0  # Don't retry on failure
            template:
              spec:
                restartPolicy: Never
                containers:
                  - name: builder
                    image: "{{ harbor_registry }}/library/tk-jupyter-base:latest"
                    imagePullPolicy: Always
                    command:
                      - bash
                      - /scripts/build-venvs.sh
                    env:
                      - name: VENVS_VERSION
                        value: "{{ venvs_version }}"
                      - name: OUTPUT_DIR
                        value: /output
                    volumeMounts:
                      - name: build-script
                        mountPath: /scripts
                      - name: output
                        mountPath: /output
                    resources:
                      requests:
                        memory: "8Gi"
                        cpu: "2"
                      limits:
                        memory: "16Gi"
                        cpu: "4"
                volumes:
                  - name: build-script
                    configMap:
                      name: venvs-build-script
                      defaultMode: 0755
                  - name: output
                    emptyDir:
                      sizeLimit: 20Gi
                # Schedule on GPU nodes to get correct architecture
                nodeSelector:
                  nvidia.com/gpu.present: "true"

    - name: Wait for build job to complete (this takes 30-60 minutes)
      kubernetes.core.k8s_info:
        api_version: batch/v1
        kind: Job
        name: "{{ job_name }}"
        namespace: "{{ build_namespace }}"
      register: job_info
      until: >
        (job_info.resources[0].status.succeeded is defined and job_info.resources[0].status.succeeded == 1) or
        (job_info.resources[0].status.failed is defined and job_info.resources[0].status.failed > 0)
      retries: 180  # 180 * 20s = 60 minutes max wait
      delay: 20

    - name: Check if build succeeded
      ansible.builtin.fail:
        msg: "Venvs build job failed! Check logs with: kubectl logs job/{{ job_name }} -n {{ build_namespace }}"
      when: job_info.resources[0].status.failed is defined and job_info.resources[0].status.failed > 0

    - name: Get builder pod name
      kubernetes.core.k8s_info:
        api_version: v1
        kind: Pod
        namespace: "{{ build_namespace }}"
        label_selectors:
          - "job-name={{ job_name }}"
      register: pod_info

    - name: Set pod name fact
      ansible.builtin.set_fact:
        builder_pod: "{{ pod_info.resources[0].metadata.name }}"

    - name: Create local output directory
      ansible.builtin.file:
        path: "{{ local_output_dir }}"
        state: directory
        mode: '0755'

    - name: Copy tarballs from pod
      ansible.builtin.command: >
        kubectl cp {{ build_namespace }}/{{ builder_pod }}:/output {{ local_output_dir }}
      register: copy_result

    - name: List downloaded tarballs
      ansible.builtin.find:
        paths: "{{ local_output_dir }}"
        patterns: "*.tar.gz"
        recurse: true
      register: tarballs

    - name: Display tarballs found
      ansible.builtin.debug:
        msg: "Found {{ tarballs.files | length }} tarballs: {{ tarballs.files | map(attribute='path') | list }}"

    - name: Check if GitHub release already exists
      ansible.builtin.command: gh release view {{ venvs_version }} --repo {{ github_repo }}
      register: release_exists
      failed_when: false
      changed_when: false

    - name: Create GitHub release (if it doesn't exist)
      ansible.builtin.command: >
        gh release create {{ venvs_version }}
        --repo {{ github_repo }}
        --title "Jupyter Venvs {{ venvs_version }}"
        --notes "Pre-built Python virtualenvs for JupyterHub.

        These venvs inherit PyTorch from the tk-jupyter-base image via --system-site-packages.

        Venvs included:
        - **ml-gpu**: Base ML packages (transformers, datasets, accelerate, etc.)
        - **fine-tuning**: ML + fine-tuning packages (bitsandbytes, peft, trl, unsloth)
        - **agent-dev**: ML + agent frameworks (langchain, crewai, langgraph, etc.)

        Architecture: arm64 (DGX Spark GB10)"
      when: release_exists.rc != 0

    - name: Upload tarballs to GitHub release
      ansible.builtin.command: >
        gh release upload {{ venvs_version }} {{ item.path }}
        --repo {{ github_repo }}
        --clobber
      loop: "{{ tarballs.files }}"
      loop_control:
        label: "{{ item.path | basename }}"

    - name: Clean up local output directory
      ansible.builtin.file:
        path: "{{ local_output_dir }}"
        state: absent

    - name: Delete build job
      kubernetes.core.k8s:
        state: absent
        api_version: batch/v1
        kind: Job
        name: "{{ job_name }}"
        namespace: "{{ build_namespace }}"

    - name: Display completion message
      ansible.builtin.debug:
        msg: |

          ════════════════════════════════════════════════════════════════
          Venvs Build and Upload Complete!
          ════════════════════════════════════════════════════════════════

          Version: {{ venvs_version }}
          GitHub Release: https://github.com/{{ github_repo }}/releases/tag/{{ venvs_version }}

          Uploaded tarballs:
          {% for tarball in tarballs.files %}
            - {{ tarball.path | basename }}
          {% endfor %}

          JupyterHub pods will automatically download these venvs on startup.

          ════════════════════════════════════════════════════════════════
