# Copyright 2025 Alejandro Mart√≠nez Corri√° and the Thinkube contributors
# SPDX-License-Identifier: Apache-2.0

---
# ansible/40_thinkube/core/infrastructure/gpu_operator/00_install.yaml
# Description:
#   Complete NVIDIA GPU Operator installation and configuration
#   Installs GPU operator and configures time-slicing for multiple workloads
#
# Usage:
#   cd ~/thinkube
#   ./scripts/run_ansible.sh ansible/40_thinkube/core/infrastructure/gpu_operator/00_install.yaml
#
# What this installs:
#   1. NVIDIA GPU Operator (device plugin, container toolkit, etc.)
#   2. GPU time-slicing (allows multiple pods to share GPUs)
#   3. GPU discovery configuration
#
# Supported GPUs:
#   - ARM64: DGX Spark GB10 (128GB unified memory)
#   - x86-64: RTX 3090, RTX 4090, and other consumer/workstation GPUs
#
# Default configuration:
#   - 4 virtual GPUs per physical GPU (configurable via gpu_time_slicing_replicas)
#
# ü§ñ [AI-assisted]

- name: Install NVIDIA GPU Operator with Time-Slicing
  hosts: k8s_control_plane
  become: false
  tasks:
    - name: Install GPU Operator
      ansible.builtin.include_tasks: 10_deploy.yaml

    - name: Configure GPU Time-Slicing
      ansible.builtin.include_tasks: 15_configure_time_slicing.yaml

    - name: Configure GPU Discovery
      ansible.builtin.include_tasks: 17_configure_discovery.yaml
