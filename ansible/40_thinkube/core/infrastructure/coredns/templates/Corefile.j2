# Copyright 2025 Alejandro Martínez Corriá and the Thinkube contributors
# SPDX-License-Identifier: Apache-2.0

.:53 {
    errors
    health {
        lameduck 5s
    }
    ready
    log
    
    # Handle Kubernetes services ONLY
    kubernetes cluster.local in-addr.arpa ip6.arpa {
        pods insecure
        fallthrough in-addr.arpa ip6.arpa
        ttl 30
    }
    
    prometheus :9153
    
    # Forward everything else to BIND9 DNS server
    # BIND9 handles domain resolution and external queries
    forward . {{ coredns_external_ip }} {
        max_concurrent 1000
    }
    
    cache 30
    loop
    reload
    loadbalance
}