#!/bin/bash

# Copyright 2025 Alejandro Martínez Corriá and the Thinkube contributors
# SPDX-License-Identifier: Apache-2.0

set -e

echo '===== Installing VS Code Extensions ====='

# Ensure extensions directory exists
mkdir -p /home/thinkube/.local/share/code-server/extensions

# Extensions directory
EXTENSION_DIR="/home/thinkube/.local/share/code-server/extensions"

# Install thinkube-ai-integration extension from cloned repo
if [ -d "/home/thinkube/thinkube-platform/thinkube-ai-integration" ]; then
  echo 'Building thinkube-ai-integration extension...'
  cd /home/thinkube/thinkube-platform/thinkube-ai-integration
  
  # Pull latest changes
  git pull || echo "Could not pull latest changes"
  
  # Build extension
  npm install --production=false
  npm run compile
  
  # Install by creating symlink
  rm -rf "$EXTENSION_DIR"/thinkube.thinkube-ai-integration-*
  ln -sf "/home/thinkube/thinkube-platform/thinkube-ai-integration" "$EXTENSION_DIR/thinkube-ai-integration"
  
  echo '✅ thinkube-ai-integration extension installed via symlink'
else
  echo '❌ thinkube-ai-integration repository not found at /home/thinkube/thinkube-platform/thinkube-ai-integration'
fi

# Install thinkube-cicd-monitor extension from cloned repo
if [ -d "/home/thinkube/thinkube-platform/thinkube-cicd-monitor" ]; then
  echo 'Building thinkube-cicd-monitor extension...'
  cd /home/thinkube/thinkube-platform/thinkube-cicd-monitor
  
  # Pull latest changes
  git pull || echo "Could not pull latest changes"
  
  # Build extension
  npm install --production=false
  npm run compile
  
  # Install by creating symlink
  rm -rf "$EXTENSION_DIR"/thinkube.thinkube-cicd-monitor-*
  ln -sf "/home/thinkube/thinkube-platform/thinkube-cicd-monitor" "$EXTENSION_DIR/thinkube-cicd-monitor"
  
  echo '✅ thinkube-cicd-monitor extension installed via symlink'
else
  echo '❌ thinkube-cicd-monitor repository not found at /home/thinkube/thinkube-platform/thinkube-cicd-monitor'
fi

# Install thinkube-theme extension from GitHub
echo 'Installing thinkube-theme...'
THEME_REPO="/tmp/thinkube-theme"
rm -rf "$THEME_REPO"

# Clone theme repository
if git clone https://github.com/thinkube/thinkube-theme.git "$THEME_REPO" 2>/dev/null; then
  # Remove any existing theme installation
  rm -rf "$EXTENSION_DIR/thinkube-theme"

  # Copy theme to extensions directory (no build needed for themes)
  cp -r "$THEME_REPO" "$EXTENSION_DIR/thinkube-theme"

  # Clean up
  rm -rf "$THEME_REPO"

  echo '✅ thinkube-theme extension installed'
else
  echo '❌ Could not clone thinkube-theme from GitHub'
fi

echo 'VS Code extensions installation complete'