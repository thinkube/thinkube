#!/bin/bash

# Copyright 2025 Alejandro Martínez Corriá and the Thinkube contributors
# SPDX-License-Identifier: Apache-2.0

# Setup SSH access for code-server
# This script configures SSH keys and access to Thinkube nodes

set -e

echo "Setting up SSH configuration for code-server..."

# Create SSH directory
mkdir -p ~/.ssh
chmod 700 ~/.ssh

# Generate SSH key for Thinkube nodes if it doesn't exist
if [ ! -f ~/.ssh/id_ed25519 ]; then
    echo "Generating SSH key for Thinkube nodes..."
    ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519 -N "" -C "coder@code-server"
fi

# Generate GitHub SSH key if it doesn't exist
if [ ! -f ~/.ssh/github_ed25519 ]; then
    echo "Generating SSH key for GitHub..."
    ssh-keygen -t ed25519 -f ~/.ssh/github_ed25519 -N "" -C "coder@code-server-github"
fi

# Display the public keys
echo ""
echo "SSH Setup Complete!"
echo "==================="
echo ""
echo "Your Thinkube SSH public key (this will be distributed to all nodes):"
cat ~/.ssh/id_ed25519.pub
echo ""
echo "Your GitHub SSH public key (add this to your GitHub account):"
cat ~/.ssh/github_ed25519.pub
echo ""
echo "To add the GitHub key to your account:"
echo "1. Copy the key above"
echo "2. Go to https://github.com/settings/keys"
echo "3. Click 'New SSH key'"
echo "4. Paste the key and save"
echo ""
echo "Available SSH connections:"
echo "- ssh ansible-controller (Thinkube management node)"
{% for host in groups['microk8s_control_plane'] %}
echo "- ssh {{ host }} (Kubernetes control plane)"
{% endfor %}
{% for host in groups['microk8s_workers'] %}
echo "- ssh {{ host }} (Kubernetes worker)"
{% endfor %}
echo ""
echo "All connections will automatically use the '{{ system_username }}' user."