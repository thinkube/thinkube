# Copyright 2025 Alejandro MartÃ­nez CorriÃ¡ and the Thinkube contributors
# SPDX-License-Identifier: Apache-2.0

---
# ansible/40_thinkube/core/code-server/15_configure_environment.yaml
# Description:
#   Configure code-server environment after deployment using kubectl exec
#   This runs IN the actual container, so all changes persist
#
# Requirements:
#   - code-server must be deployed (10_deploy.yaml)
#   - Pod must be running and ready
#
# Usage:
#   cd ~/thinkube
#   ./scripts/run_ansible.sh ansible/40_thinkube/core/code-server/15_configure_environment.yaml
#
# ðŸ¤– [AI-assisted]

- name: Configure code-server environment
  hosts: microk8s_control_plane
  gather_facts: true
  
  vars:
    code_server_namespace: "code-server"
    kubectl_bin: "microk8s.kubectl"
    kubeconfig: "/var/snap/microk8s/current/credentials/client.config"
    shared_code_path: "/home/{{ system_username }}/shared-code"
    code_source_path: "{{ shared_code_path }}"

  tasks:
    - name: Get code-server pod name
      ansible.builtin.shell: |
        {{ kubectl_bin }} get pods -n {{ code_server_namespace }} \
          -l app=code-server \
          -o jsonpath='{.items[0].metadata.name}'
      register: pod_name
      failed_when: pod_name.stdout == ""
      
    - name: Wait for pod to be ready
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        api_version: v1
        kind: Pod
        namespace: "{{ code_server_namespace }}"
        name: "{{ pod_name.stdout }}"
        wait: true
        wait_condition:
          type: Ready
          status: "True"
        wait_timeout: 300
        
    # NOTE: Node.js 20.x and code symlink are now installed in the Docker image
    # No need to install them here

    - name: Configure npm for global installations
      ansible.builtin.shell: |
        {{ kubectl_bin }} exec -n {{ code_server_namespace }} {{ pod_name.stdout }} -- \
          bash -c "
            mkdir -p /home/thinkube/.npm-global
            npm config set prefix '/home/thinkube/.npm-global'
            
            # Add to PATH in shell configs only if not already present
            if ! grep -q '/home/thinkube/.npm-global/bin' /home/thinkube/.bashrc 2>/dev/null; then
              echo 'export PATH=/home/thinkube/.npm-global/bin:\$PATH' >> /home/thinkube/.bashrc
            fi
            
            if ! grep -q '/home/thinkube/.npm-global/bin' /home/thinkube/.profile 2>/dev/null; then
              echo 'export PATH=/home/thinkube/.npm-global/bin:\$PATH' >> /home/thinkube/.profile
            fi
          "
          
    - name: Install Claude Code
      ansible.builtin.shell: |
        {{ kubectl_bin }} exec -n {{ code_server_namespace }} {{ pod_name.stdout }} -- \
          bash -l -c "
            npm config set prefix '/home/thinkube/.npm-global'
            npm install -g @anthropic-ai/claude-code
          "
          
    - name: Create claude wrapper script content
      ansible.builtin.set_fact:
        claude_wrapper_content: |
          #!/bin/bash
          # Wrapper script for Claude Code to ensure PATH is set correctly
          export PATH="/home/thinkube/.npm-global/bin:$PATH"
          exec /home/thinkube/.npm-global/bin/claude "$@"
          
    - name: Copy claude wrapper script
      ansible.builtin.shell: |
        {{ kubectl_bin }} exec -n {{ code_server_namespace }} {{ pod_name.stdout }} -- \
          bash -c 'cat > /tmp/claude-wrapper.sh << "EOF"
          {{ claude_wrapper_content }}
          EOF'
          
    - name: Install claude wrapper script
      ansible.builtin.shell: |
        {{ kubectl_bin }} exec -n {{ code_server_namespace }} {{ pod_name.stdout }} -- \
          bash -c "sudo mv /tmp/claude-wrapper.sh /usr/local/bin/claude && sudo chmod +x /usr/local/bin/claude"

    # NOTE: Python, Ansible, and copier are now installed system-wide in the Docker image
    # No venv creation needed - tools are always available

    - name: Create Ansible configuration content
      ansible.builtin.set_fact:
        ansible_cfg_content: |
          [defaults]
          host_key_checking = False
          inventory = /home/thinkube/thinkube-platform/thinkube/inventory/hosts.yaml
          remote_user = {{ system_username }}
          private_key_file = /host-ssh/thinkube_cluster_key
          interpreter_python = auto_silent
          
          [ssh_connection]
          ssh_args = -o ControlMaster=auto -o ControlPersist=60s -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no
          
    - name: Copy Ansible configuration
      ansible.builtin.shell: |
        {{ kubectl_bin }} exec -n {{ code_server_namespace }} {{ pod_name.stdout }} -- \
          bash -c 'cat > /home/thinkube/.ansible.cfg << "EOF"
          {{ ansible_cfg_content }}
          EOF'
          
    - name: Create thinkube-platform directory structure
      ansible.builtin.shell: |
        {{ kubectl_bin }} exec -n {{ code_server_namespace }} {{ pod_name.stdout }} -- \
          bash -c "mkdir -p /home/thinkube/thinkube-platform"

    - name: Fetch repository metadata from thinkube-metadata
      ansible.builtin.uri:
        url: "https://raw.githubusercontent.com/thinkube/thinkube-metadata/main/repositories.json"
        return_content: yes
      register: repo_metadata
      failed_when: repo_metadata.status != 200

    - name: Parse repository list for development cloning
      ansible.builtin.set_fact:
        repos_to_clone: "{{ (repo_metadata.content | from_json).repositories | selectattr('clone_for_development', 'equalto', true) | map(attribute='full_name') | list }}"
      failed_when: repos_to_clone | length == 0

    - name: Clone platform repositories
      ansible.builtin.shell: |
        {{ kubectl_bin }} exec -n {{ code_server_namespace }} {{ pod_name.stdout }} -- \
          bash -c "
            set -e
            echo '===== Cloning platform repositories ====='

            # Check if SSH key exists
            if [ -f /home/thinkube/.ssh/github_ed25519 ]; then
              echo 'GitHub SSH key found at /home/thinkube/.ssh/github_ed25519'
              chmod 600 /home/thinkube/.ssh/github_ed25519

              # Repository list fetched from thinkube-metadata
              REPOS=(
                {% for repo in repos_to_clone %}
                '{{ repo }}'
                {% endfor %}
              )

              echo \"Cloning {{ repos_to_clone | length }} repositories from metadata...\"

              # Clone or update each repository
              for repo in \"\${REPOS[@]}\"; do
                repo_name=\$(basename \$repo)
                if [ ! -d \"/home/thinkube/thinkube-platform/\$repo_name\" ]; then
                  echo \"Cloning \$repo...\"
                  GIT_SSH_COMMAND='ssh -i /home/thinkube/.ssh/github_ed25519 -o StrictHostKeyChecking=no' \
                    git clone \"git@github.com:\$repo.git\" \"/home/thinkube/thinkube-platform/\$repo_name\" || \
                    echo \"Warning: Failed to clone \$repo (may be private or not exist)\"
                else
                  echo \"\$repo_name already exists, pulling latest changes...\"
                  cd \"/home/thinkube/thinkube-platform/\$repo_name\"
                  # Reset any local changes to avoid merge conflicts
                  git reset --hard HEAD
                  GIT_SSH_COMMAND='ssh -i /home/thinkube/.ssh/github_ed25519 -o StrictHostKeyChecking=no' \
                    git pull || echo \"Warning: Failed to pull latest changes for \$repo_name\"
                fi
              done
            else
              echo 'ERROR: No SSH key found at /home/thinkube/.ssh/github_ed25519'
              echo 'Please ensure GitHub SSH key is properly configured'
              exit 1
            fi
          "

    ###################################################################
    # Configure CLI Tools for Development
    ###################################################################

    - name: Configure kubectl (copy kubeconfig from MicroK8s)
      ansible.builtin.shell: |
        {{ kubectl_bin }} cp {{ kubeconfig }} \
          {{ code_server_namespace }}/{{ pod_name.stdout }}:/tmp/kubeconfig
        {{ kubectl_bin }} exec -n {{ code_server_namespace }} {{ pod_name.stdout }} -- \
          bash -c "
            mkdir -p /home/thinkube/.kube
            mv /tmp/kubeconfig /home/thinkube/.kube/config
            chmod 600 /home/thinkube/.kube/config
            echo 'âœ… kubectl configured'
          "

    - name: Configure GitHub CLI (gh auth)
      ansible.builtin.shell: |
        {{ kubectl_bin }} exec -n {{ code_server_namespace }} {{ pod_name.stdout }} -- \
          bash -c "
            echo '{{ lookup('env', 'GITHUB_TOKEN') }}' | gh auth login --with-token
            gh auth status
            echo 'âœ… GitHub CLI authenticated'
          "
      no_log: true
      when: lookup('env', 'GITHUB_TOKEN') != ''

    - name: Configure ArgoCD CLI
      ansible.builtin.shell: |
        # Read ArgoCD token from control plane .env file
        ARGOCD_TOKEN=$(grep ARGOCD_DEPLOYMENT_SECRET {{ ansible_env.HOME }}/.env | cut -d= -f2 | tr -d '"')

        # Copy token to code-server and login
        {{ kubectl_bin }} exec -n {{ code_server_namespace }} {{ pod_name.stdout }} -- \
          bash -c "
            argocd login {{ argocd_grpc_hostname }} \
              --auth-token '$ARGOCD_TOKEN' \
              --grpc-web
            echo 'âœ… ArgoCD CLI configured'
          "
      no_log: true

    - name: Get Argo Workflows service account token
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        api_version: v1
        kind: Secret
        namespace: argo
        name: argo-workflows-server-sa-token
      register: argo_sa_secret
      failed_when: argo_sa_secret.resources | length == 0

    - name: Create Argo Workflows config from template
      ansible.builtin.template:
        src: templates/argo_config.j2
        dest: /tmp/argo-config
        mode: '0600'
      vars:
        argo_service_account_token: "{{ argo_sa_secret.resources[0].data.token | b64decode }}"
      no_log: true

    - name: Copy Argo config to code-server pod
      ansible.builtin.shell: |
        {{ kubectl_bin }} exec -n {{ code_server_namespace }} {{ pod_name.stdout }} -- mkdir -p /home/thinkube/.config/argo
        {{ kubectl_bin }} cp /tmp/argo-config {{ code_server_namespace }}/{{ pod_name.stdout }}:/home/thinkube/.config/argo/config
        {{ kubectl_bin }} exec -n {{ code_server_namespace }} {{ pod_name.stdout }} -- chmod 600 /home/thinkube/.config/argo/config
        rm -f /tmp/argo-config
        echo 'âœ… Argo Workflows CLI configured'
      no_log: true

    - name: Get Gitea admin token
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        api_version: v1
        kind: Secret
        namespace: gitea
        name: gitea-admin-token
      register: gitea_token_secret
      failed_when: gitea_token_secret.resources | length == 0

    - name: Configure Tea (Gitea CLI)
      ansible.builtin.shell: |
        {{ kubectl_bin }} exec -n {{ code_server_namespace }} {{ pod_name.stdout }} -- \
          bash -c "
            tea login add \
              --name {{ gitea_hostname }} \
              --url https://{{ gitea_hostname }} \
              --token '{{ gitea_token_secret.resources[0].data.token | b64decode }}' \
              --insecure
            echo 'âœ… Tea (Gitea CLI) configured'
          "
      no_log: true

    - name: Read Harbor robot token from .env
      ansible.builtin.shell: grep HARBOR_ROBOT_TOKEN {{ ansible_env.HOME }}/.env | cut -d= -f2 | tr -d '"'
      register: harbor_token_result
      changed_when: false
      no_log: true

    - name: Create Harbor auth base64 string
      ansible.builtin.shell: echo -n 'robot${{ harbor_robot_name }}:{{ harbor_token_result.stdout }}' | base64 -w0
      register: harbor_auth_result
      changed_when: false
      no_log: true

    - name: Create Docker config from template
      ansible.builtin.template:
        src: templates/docker-config.json.j2
        dest: /tmp/docker-config.json
        mode: '0600'
      vars:
        harbor_auth_b64: "{{ harbor_auth_result.stdout }}"
      no_log: true

    - name: Copy Docker config to code-server pod
      ansible.builtin.shell: |
        {{ kubectl_bin }} exec -n {{ code_server_namespace }} {{ pod_name.stdout }} -- mkdir -p /home/thinkube/.docker
        {{ kubectl_bin }} cp /tmp/docker-config.json {{ code_server_namespace }}/{{ pod_name.stdout }}:/home/thinkube/.docker/config.json
        {{ kubectl_bin }} exec -n {{ code_server_namespace }} {{ pod_name.stdout }} -- chmod 600 /home/thinkube/.docker/config.json
        rm -f /tmp/docker-config.json
        echo 'âœ… Harbor/Docker credentials configured'
      no_log: true

    - name: Create CLI tools test script from template
      ansible.builtin.template:
        src: templates/test-cli-tools.sh.j2
        dest: /tmp/test-cli-tools-{{ ansible_date_time.epoch }}.sh
        mode: '0755'
      register: test_script

    - name: Copy test script to code-server pod
      ansible.builtin.shell: |
        {{ kubectl_bin }} cp {{ test_script.dest }} \
          {{ code_server_namespace }}/{{ pod_name.stdout }}:/home/thinkube/test-cli-tools.sh \
          -c code-server
        {{ kubectl_bin }} exec -n {{ code_server_namespace }} {{ pod_name.stdout }} -- \
          chmod +x /home/thinkube/test-cli-tools.sh

    - name: Clean up temporary test script
      ansible.builtin.file:
        path: "{{ test_script.dest }}"
        state: absent

    - name: Create VS Code workspace settings content
      ansible.builtin.set_fact:
        vscode_workspace_settings: |
          {
            "files.exclude": {
              "**/.cache": true,
              "**/.config": true,
              "**/.local": true,
              "**/.npm": true,
              "**/.npm-global": true,
              "**/.vscode-server": true,
              "**/.ansible": true,
              "**/.venv": true,
              "**/.ansible.cfg": true,
              "**/.ssh": true,
              "**/.gitconfig": true,
              "**/.npmrc": true,
              "**/.profile": true,
              "**/.bashrc": true,
              "**/.bash_history": true,
              "**/.claude.json": true,
              "**/claude.json": true,
              "**/ansible/.ansible": true,
              "**/tmp": true,
              "**/node_modules": true,
              "**/create-gitea-repo.sh": true,
              "**/setup-gitea-workflow.sh": true,
              "**/.git": false,
              "**/.gitignore": false
            },
            "explorer.excludeGitIgnore": false,
            "search.exclude": {
              "**/.cache": true,
              "**/.config": true,
              "**/.local": true,
              "**/.npm": true,
              "**/.npm-global": true,
              "**/.vscode-server": true,
              "**/.venv": true,
              "**/node_modules": true,
              "**/tmp": true,
              "**/.bash_history": true
            },
            "terminal.integrated.defaultProfile.linux": "bash",
            "terminal.integrated.profiles.linux": {
              "bash": {
                "path": "/bin/bash",
                "args": ["-l"]
              }
            }
          }
          
    - name: Create .vscode directory
      ansible.builtin.shell: |
        {{ kubectl_bin }} exec -n {{ code_server_namespace }} {{ pod_name.stdout }} -- \
          bash -c "mkdir -p /home/thinkube/.vscode"
          
    - name: Copy VS Code workspace settings
      ansible.builtin.shell: |
        {{ kubectl_bin }} exec -n {{ code_server_namespace }} {{ pod_name.stdout }} -- \
          bash -c 'cat > /home/thinkube/.vscode/settings.json << "EOF"
          {{ vscode_workspace_settings }}
          EOF'
          
    - name: Create extension installation script from template
      ansible.builtin.template:
        src: templates/install-extensions.sh.j2
        dest: /tmp/install-extensions-{{ ansible_date_time.epoch }}.sh
        mode: '0755'
      register: install_script
      
    - name: Copy installation script to pod
      ansible.builtin.shell: |
        {{ kubectl_bin }} cp {{ install_script.dest }} \
          {{ code_server_namespace }}/{{ pod_name.stdout }}:/tmp/install-extensions.sh \
          -c code-server
          
    - name: Install VS Code extensions
      ansible.builtin.shell: |
        {{ kubectl_bin }} exec -n {{ code_server_namespace }} {{ pod_name.stdout }} -- \
          bash /tmp/install-extensions.sh
      register: extension_install
      
    - name: Clean up temporary script
      ansible.builtin.file:
        path: "{{ install_script.dest }}"
        state: absent
      
    - name: Display extension installation output
      ansible.builtin.debug:
        var: extension_install.stdout_lines
      when: extension_install is defined
      
    - name: Create temporary settings file from template
      ansible.builtin.template:
        src: templates/vscode-settings.json.j2
        dest: /tmp/vscode-settings-{{ ansible_date_time.epoch }}.json
        mode: '0644'
      register: temp_settings_file
      
    - name: Ensure VS Code user settings directory exists on host with correct permissions
      ansible.builtin.file:
        path: "{{ code_source_path }}/.local/share/code-server/User"
        state: directory
        owner: "{{ system_username }}"
        group: "{{ system_username }}"
        mode: '0755'
      become: true

    - name: Remove existing settings file if present (from host)
      ansible.builtin.file:
        path: "{{ code_source_path }}/.local/share/code-server/User/settings.json"
        state: absent
      become: true

    - name: Copy settings file to pod
      ansible.builtin.shell: |
        {{ kubectl_bin }} cp {{ temp_settings_file.dest }} \
          {{ code_server_namespace }}/{{ pod_name.stdout }}:/home/thinkube/.local/share/code-server/User/settings.json \
          -c code-server
      register: extension_config
      
    - name: Clean up temporary file
      ansible.builtin.file:
        path: "{{ temp_settings_file.dest }}"
        state: absent
      
    - name: Display extension configuration output
      ansible.builtin.debug:
        var: extension_config.stdout_lines
      when: extension_config is defined

    - name: Display setup summary
      ansible.builtin.debug:
        msg:
          - "âœ… Code-server environment configured successfully"
          - "âœ… Node.js and npm installed"
          - "âœ… Claude Code installed and available"
          - "âœ… Python and Ansible installed"
          - "âœ… Repository cloned (if SSH key available)"
          - "âœ… VS Code extensions installed (if repositories available)"
          - "âœ… VS Code workspace configured with clean file explorer"
          - "âœ… Nerd Fonts injected (Fira Code, JetBrains Mono)"
          - ""
          - "The 'claude' command should now work in any new terminal session"
          - ""
          - "Extensions installed:"
          - "  - thinkube-ai-integration (via symlink from platform repo)"
          - "  - thinkube-cicd-monitor (via symlink from platform repo)"
          - "  - Hooks are configured for Ansible playbook review"
          - ""
          - "ðŸ’¡ Reload browser to see Nerd Font icons in terminal"