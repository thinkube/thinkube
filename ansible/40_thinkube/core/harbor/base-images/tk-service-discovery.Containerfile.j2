# Copyright 2025 Alejandro Martínez Corriá and the Thinkube contributors
# SPDX-License-Identifier: Apache-2.0

# Service discovery init container for JupyterHub
# Queries Kubernetes ConfigMaps and generates environment files
FROM library/alpine:3.19

# Install required tools for service discovery
RUN apk add --no-cache \
    # Shell
    bash \
    # YAML/JSON processing
    jq \
    yq \
    # Kubernetes client
    curl \
    ca-certificates

# Install kubectl from official Kubernetes release
ARG TARGETARCH
RUN KUBECTL_VERSION=$(curl -L -s https://dl.k8s.io/release/stable.txt) && \
    curl -LO "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/${TARGETARCH}/kubectl" && \
    chmod +x kubectl && \
    mv kubectl /usr/local/bin/kubectl

# Verify installations
RUN kubectl version --client && \
    jq --version && \
    yq --version

# Set bash as default shell
SHELL ["/bin/bash", "-c"]

# Default working directory
WORKDIR /scripts

# Health check - verify tools are available
HEALTHCHECK NONE

# Default command
CMD ["/bin/bash"]
