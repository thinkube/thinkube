# Copyright 2025 Alejandro Martínez Corriá and the Thinkube contributors
# SPDX-License-Identifier: Apache-2.0

# Shared Node.js base image with common dependencies
FROM {{ harbor_registry }}/library/node:22-alpine

# Install system dependencies
RUN apk add --no-cache \
    git \
    python3 \
    make \
    g++ \
    curl \
    bash \
    jq

# Install global npm packages
RUN npm install -g \
    pnpm@latest

# Set npm configuration for better caching
RUN npm config set fetch-retry-maxtimeout 60000 && \
    npm config set fetch-retry-mintimeout 10000 && \
    npm config set fetch-retries 5

# Create app directory
WORKDIR /app

# Pre-install common dependencies to warm up cache with updated versions for Node 22
# Includes dependencies for thinkube-control React/Next.js frontend
RUN npm init -y && \
    npm install --save \
    next@16 \
    react@19 \
    react-dom@19 \
    axios@1 \
    zustand@5 \
    tailwindcss@4 \
    @radix-ui/react-alert-dialog@1 \
    @radix-ui/react-dialog@1 \
    @radix-ui/react-dropdown-menu@2 \
    @radix-ui/react-slot@1 \
    @radix-ui/react-tabs@1 \
    @dnd-kit/core@6 \
    @dnd-kit/sortable@9 \
    class-variance-authority@0 \
    clsx@2 \
    lucide-react@0 \
    next-themes@0 \
    sonner@1 \
    tailwind-merge@3 && \
    npm install --save-dev \
    typescript@5 \
    @types/node@20 \
    @types/react@19 \
    @types/react-dom@19 \
    eslint@9 \
    vitest@1 \
    prettier@3 && \
    rm -rf node_modules package*.json

ENV NODE_ENV=development