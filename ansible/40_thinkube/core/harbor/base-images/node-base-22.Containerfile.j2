# Copyright 2025 Alejandro Martínez Corriá and the Thinkube contributors
# SPDX-License-Identifier: Apache-2.0

# Shared Node.js base image with common dependencies
FROM {{ harbor_registry }}/library/node:22-alpine

# Install system dependencies
RUN apk add --no-cache \
    git \
    python3 \
    make \
    g++ \
    curl \
    bash \
    jq

# Install global npm packages
RUN npm install -g \
    pnpm@latest

# Set npm configuration for better caching
RUN npm config set fetch-retry-maxtimeout 60000 && \
    npm config set fetch-retry-mintimeout 10000 && \
    npm config set fetch-retries 5

# Create app directory
WORKDIR /app

# Pre-install common dependencies to warm up cache with updated versions for Node 22
RUN npm init -y && \
    npm install --save \
    vue@3 \
    vue-router@4 \
    axios@1 \
    @vitejs/plugin-vue@6 \
    vite@7 && \
    npm install --save-dev \
    @vue/test-utils@2 \
    vitest@1 \
    @vitest/ui@1 \
    eslint@8 \
    prettier@3 && \
    rm -rf node_modules package*.json

ENV NODE_ENV=development