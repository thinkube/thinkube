#!/bin/bash
# Copyright 2025 Alejandro Martínez Corriá and the Thinkube contributors
# SPDX-License-Identifier: Apache-2.0

# Image identifier for organizing examples
IMAGE_NAME="{{ image_name }}"
EXAMPLES_REPO="/home/jovyan/thinkube/examples-repo/jupyter-examples"

# Ensure persistent notebooks directory exists
mkdir -p /home/jovyan/thinkube/notebooks

# Fail fast if examples repository is not available
if [ ! -d "$EXAMPLES_REPO" ]; then
  echo "ERROR: Examples repository not found at $EXAMPLES_REPO"
  echo "Expected structure: /home/jovyan/thinkube/examples-repo/jupyter-examples/"
  exit 1
fi

# Create symlink to read-only templates (from shared repository)
if [ ! -e "/home/jovyan/thinkube/notebooks/templates" ]; then
  echo "Creating symlink to read-only templates from repository..."
  ln -s "$EXAMPLES_REPO" /home/jovyan/thinkube/notebooks/templates
elif [ ! -L "/home/jovyan/thinkube/notebooks/templates" ]; then
  echo "Removing non-symlink templates and recreating..."
  rm -rf /home/jovyan/thinkube/notebooks/templates
  ln -s "$EXAMPLES_REPO" /home/jovyan/thinkube/notebooks/templates
fi

# Determine which examples to copy based on image type
EXAMPLE_DIRS="common"  # Always include common

case "$IMAGE_NAME" in
  tk-jupyter-ml-cpu)
    EXAMPLE_DIRS="common ml-cpu"
    ;;
  tk-jupyter-ml-gpu)
    EXAMPLE_DIRS="common ml-gpu"
    ;;
  tk-jupyter-fine-tuning)
    EXAMPLE_DIRS="common fine-tuning"
    ;;
  tk-jupyter-agent-dev)
    EXAMPLE_DIRS="common agent-dev"
    ;;
  *)
    echo "Unknown image type: $IMAGE_NAME, using common examples only"
    ;;
esac

# Copy examples to image-specific folder (allows multiple images to coexist)
if [ ! -f "/home/jovyan/thinkube/notebooks/examples/${IMAGE_NAME}/.copied" ]; then
  echo "Copying editable example notebooks to examples/${IMAGE_NAME}/..."
  mkdir -p "/home/jovyan/thinkube/notebooks/examples/${IMAGE_NAME}"

  for dir in $EXAMPLE_DIRS; do
    if [ -d "$EXAMPLES_REPO/$dir" ]; then
      echo "  - Copying $dir examples..."
      mkdir -p "/home/jovyan/thinkube/notebooks/examples/${IMAGE_NAME}/$dir"
      cp -r "$EXAMPLES_REPO/$dir"/* "/home/jovyan/thinkube/notebooks/examples/${IMAGE_NAME}/$dir/" 2>/dev/null || true
    else
      echo "  - WARNING: Directory $EXAMPLES_REPO/$dir not found, skipping"
    fi
  done

  touch "/home/jovyan/thinkube/notebooks/examples/${IMAGE_NAME}/.copied"
  echo "Examples copied successfully"
fi

# Ensure PATH includes user's local bin where jupyterhub-singleuser is installed
export PATH="/home/jovyan/.local/bin:${PATH}"

# Start whatever command was passed
exec "$@"