#!/bin/bash
# Image identifier for organizing examples
IMAGE_NAME="{{ image_name }}"

# Ensure notebooks directory exists
mkdir -p /home/jovyan/notebooks

# Create symlink to read-only templates (always fresh from image)
if [ ! -e "/home/jovyan/notebooks/templates" ]; then
  echo "Creating symlink to read-only templates..."
  ln -s /opt/thinkube/examples /home/jovyan/notebooks/templates
elif [ ! -L "/home/jovyan/notebooks/templates" ]; then
  echo "Removing non-symlink templates and recreating..."
  rm -rf /home/jovyan/notebooks/templates
  ln -s /opt/thinkube/examples /home/jovyan/notebooks/templates
fi

# Copy examples to image-specific folder (allows multiple images to coexist)
if [ ! -f "/home/jovyan/notebooks/examples/${IMAGE_NAME}/.copied" ] && [ -d "/opt/thinkube/examples" ]; then
  echo "Copying editable example notebooks to examples/${IMAGE_NAME}/..."
  mkdir -p "/home/jovyan/notebooks/examples/${IMAGE_NAME}"
  cp -r /opt/thinkube/examples/* "/home/jovyan/notebooks/examples/${IMAGE_NAME}/" 2>/dev/null || true
  touch "/home/jovyan/notebooks/examples/${IMAGE_NAME}/.copied"
fi

# Ensure PATH includes user's local bin where jupyterhub-singleuser is installed
export PATH="/home/jovyan/.local/bin:${PATH}"

# If the command is jupyterhub-singleuser without a path, use the full path
if [ "$1" = "jupyterhub-singleuser" ]; then
  shift
  exec /home/jovyan/.local/bin/jupyterhub-singleuser "$@"
else
  # Start whatever command was passed
  exec "$@"
fi