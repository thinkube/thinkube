# Copyright 2025 Alejandro MartÃ­nez CorriÃ¡ and the Thinkube contributors
# SPDX-License-Identifier: Apache-2.0

# Jupyter Agent Development - AI agent development environment
# Base: jupyter-ml-cpu (PyTorch CPU + ML libraries)
# Includes: LangChain, CrewAI, vector databases for agent development

FROM {{ harbor_registry }}/library/tk-jupyter-ml-cpu:latest

USER $NB_UID

# Install LangChain and related packages
RUN pip install --no-cache-dir \
    langchain \
    langchain-community \
    langchain-openai

# Install CrewAI and tools
RUN pip install --no-cache-dir \
    crewai \
    crewai-tools

# Install additional vector database clients
RUN pip install --no-cache-dir \
    chromadb \
    faiss-cpu

# All Thinkube service clients are inherited from base image

# Override startup script with correct image name
USER root
RUN cat > /usr/local/bin/startup.sh << 'EOF'
#!/bin/bash
# Image identifier for organizing examples
IMAGE_NAME="tk-jupyter-agent-dev"

# Create symlink to read-only templates (always fresh from image)
if [ ! -L "/home/jovyan/notebooks/templates" ]; then
  echo "Creating symlink to read-only templates..."
  ln -s /opt/thinkube/examples /home/jovyan/notebooks/templates
fi

# Copy examples to image-specific folder (allows multiple images to coexist)
if [ ! -f "/home/jovyan/notebooks/examples/${IMAGE_NAME}/.copied" ] && [ -d "/opt/thinkube/examples" ]; then
  echo "Copying editable example notebooks to examples/${IMAGE_NAME}/..."
  mkdir -p "/home/jovyan/notebooks/examples/${IMAGE_NAME}"
  cp -r /opt/thinkube/examples/* "/home/jovyan/notebooks/examples/${IMAGE_NAME}/" 2>/dev/null || true
  touch "/home/jovyan/notebooks/examples/${IMAGE_NAME}/.copied"
fi

# Start JupyterLab
exec jupyter lab "$@"
EOF

RUN chmod +x /usr/local/bin/startup.sh
USER $NB_UID

# ðŸ¤– AI-assisted