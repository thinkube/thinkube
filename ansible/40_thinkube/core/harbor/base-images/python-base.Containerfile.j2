# Copyright 2025 Alejandro Martínez Corriá and the Thinkube contributors
# SPDX-License-Identifier: Apache-2.0

# Shared Python base image with common dependencies
FROM {{ harbor_registry }}/library/python:3.12-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    git \
    curl \
    jq \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# Install common Python packages that rarely change
# Includes dependencies for thinkube-control backend
RUN pip install --no-cache-dir \
    # Web framework dependencies
    uvicorn==0.32.1 \
    fastapi==0.115.5 \
    pydantic==2.10.3 \
    pydantic-settings==2.6.1 \
    # Database
    sqlalchemy==2.0.36 \
    asyncpg==0.30.0 \
    alembic==1.14.0 \
    psycopg2-binary==2.9.10 \
    # HTTP clients
    httpx==0.28.1 \
    requests==2.32.3 \
    aiohttp==3.10.0 \
    # Testing dependencies
    pytest==8.3.4 \
    pytest-asyncio==0.25.0 \
    pytest-cov==6.0.0 \
    faker==20.1.0 \
    # Code quality
    flake8==7.1.1 \
    black==24.10.0 \
    isort==5.13.0 \
    # Utilities
    python-jose[cryptography]==3.3.0 \
    PyJWT==2.10.1 \
    python-multipart==0.0.20 \
    cryptography==44.0.0 \
    kubernetes==31.0.0 \
    websockets==15.0.1 \
    pyyaml==6.0.2 \
    jinja2==3.1.2 \
    boto3==1.35.76 \
    # MCP support (thinkube-control uses fastapi-mcp, not fastmcp)
    fastapi-mcp==0.4.0 \
    sse-starlette>=2.1.3 \
    starlette>=0.27.0

# Set Python environment variables
ENV PYTHONPATH=/app \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=0 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

WORKDIR /app