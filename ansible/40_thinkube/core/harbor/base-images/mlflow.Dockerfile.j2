FROM {{ harbor_registry }}/library/python:3.12-slim
WORKDIR /mlflow
# Install build dependencies for psycopg2
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        gcc \
        python3-dev \
        libpq-dev \
        build-essential \
        && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*
# Install MLflow and dependencies
RUN pip install --no-cache-dir \
    mlflow==3.4.0 \
    psycopg2-binary \
    boto3 \
    mlflow-oidc-auth[full] \
    PyJWT
# Create directory for local artifacts
RUN mkdir -p /mlflow/local-artifacts && \
    chmod -R 777 /mlflow
# Set environment variables
ENV PYTHONUNBUFFERED=1
# Expose the MLflow server port
EXPOSE 5000
# Default command - this can be overridden at runtime
ENTRYPOINT ["mlflow"]
CMD ["server", "--host=0.0.0.0", "--port=5000"]