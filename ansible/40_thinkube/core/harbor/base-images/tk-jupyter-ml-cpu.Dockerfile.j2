# Copyright 2025 Alejandro MartÃ­nez CorriÃ¡ and the Thinkube contributors
# SPDX-License-Identifier: Apache-2.0

# Jupyter ML CPU - Machine Learning development environment without GPU
# Base: Ubuntu 24.04 with Python 3.12
# Includes: PyTorch CPU, ML libraries, and all Thinkube service clients

FROM {{ harbor_registry }}/library/ubuntu:24.04

# Avoid prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install Python 3.12 and system dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        python3.12 \
        python3.12-venv \
        python3-pip \
        git \
        wget \
        curl \
        vim \
        build-essential \
        ca-certificates \
    && rm -rf /var/lib/apt/lists/* \
    && rm -f /usr/lib/python*/EXTERNALLY-MANAGED

# Set Python 3.12 as default
RUN update-alternatives --install /usr/bin/python python /usr/bin/python3.12 1 && \
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 1

# Get existing UID 1000 user or create jovyan
RUN if id 1000 2>/dev/null; then \
        NB_USER=$(id -nu 1000); \
        if [ "$NB_USER" != "jovyan" ]; then \
            usermod -l jovyan -d /home/jovyan -m $NB_USER; \
        fi; \
    else \
        useradd -m -s /bin/bash -N -u 1000 jovyan; \
    fi

ENV NB_UID=1000
ENV NB_GID=100

USER jovyan
WORKDIR /home/jovyan

# Install JupyterLab and JupyterHub (needed for jupyterhub-singleuser command)
RUN python -m pip install --no-cache-dir --user \
    jupyterlab \
    jupyterhub

# Install PyTorch CPU and ML libraries
# Versions will be determined by MCP tk-package-version
RUN python -m pip install --no-cache-dir --user \
    torch \
    torchvision \
    pandas \
    scikit-learn \
    matplotlib \
    seaborn \
    plotly

# Install Thinkube service clients - Deployed services
RUN python -m pip install --no-cache-dir --user \
    psycopg2-binary \
    redis \
    qdrant-client \
    opensearch-py \
    mlflow \
    boto3

# Install Thinkube service clients - Planned services
RUN python -m pip install --no-cache-dir --user \
    weaviate-client \
    litellm \
    label-studio-sdk

# Install common utilities
RUN python -m pip install --no-cache-dir --user \
    python-dotenv \
    requests \
    httpx \
    pydantic

# Copy Thinkube environment configuration
USER root
COPY .thinkube_env /home/jovyan/.thinkube_env
RUN chown $NB_UID:$NB_GID /home/jovyan/.thinkube_env
USER $NB_UID

# Source Thinkube environment in bashrc
RUN echo 'if [ -f /home/jovyan/.thinkube_env ]; then source /home/jovyan/.thinkube_env; fi' >> /home/jovyan/.bashrc

# Copy examples to /opt where they won't be overlaid by volume mounts
USER root
RUN mkdir -p /opt/thinkube/examples
COPY thinkube_services.ipynb /opt/thinkube/examples/thinkube_services.ipynb
RUN chmod -R 755 /opt/thinkube

# Copy startup script (templated with correct image name)
COPY startup.sh /usr/local/bin/startup.sh
RUN chmod +x /usr/local/bin/startup.sh
USER $NB_UID

WORKDIR /home/jovyan

# Expose JupyterLab port
EXPOSE 8888

# Use startup script as entrypoint to handle examples, then run the command
ENTRYPOINT ["/usr/local/bin/startup.sh"]

# Default command for standalone use (JupyterHub will override with jupyterhub-singleuser)
CMD ["jupyter", "lab", "--ip=0.0.0.0", "--port=8888", "--no-browser", "--allow-root"]

# ðŸ¤– AI-assisted