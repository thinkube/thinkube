# Copyright 2025 Alejandro MartÃ­nez CorriÃ¡ and the Thinkube contributors
# SPDX-License-Identifier: Apache-2.0

# Jupyter ML CPU - Machine Learning development environment without GPU
# Base: Ubuntu 24.04 with Python 3.12
# Includes: PyTorch CPU, ML libraries, and all Thinkube service clients

FROM {{ harbor_registry }}/library/ubuntu:24.04

# Avoid prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive

# Install Python 3.12 and system dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        python3.12 \
        python3.12-venv \
        python3-pip \
        git \
        wget \
        curl \
        vim \
        build-essential \
        ca-certificates \
    && rm -rf /var/lib/apt/lists/* \
    && rm -f /usr/lib/python*/EXTERNALLY-MANAGED

# Set Python 3.12 as default
RUN update-alternatives --install /usr/bin/python python /usr/bin/python3.12 1 && \
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 1

# Get existing UID 1000 user or create jovyan
RUN if id 1000 2>/dev/null; then \
        NB_USER=$(id -nu 1000); \
        if [ "$NB_USER" != "jovyan" ]; then \
            usermod -l jovyan -d /home/jovyan -m $NB_USER; \
        fi; \
    else \
        useradd -m -s /bin/bash -N -u 1000 jovyan; \
    fi

ENV NB_UID=1000
ENV NB_GID=100

USER jovyan
WORKDIR /home/jovyan

# Install JupyterLab and JupyterHub (needed for jupyterhub-singleuser command)
RUN python -m pip install --no-cache-dir --user \
    jupyterlab==4.4.9 \
    jupyterhub==5.3.0

# Install PyTorch CPU from the CPU-specific index
RUN python -m pip install --no-cache-dir --user \
    torch==2.5.1+cpu \
    torchvision==0.20.1+cpu \
    --index-url https://download.pytorch.org/whl/cpu

# Install ML and data science libraries
RUN python -m pip install --no-cache-dir --user \
    pandas==2.3.2 \
    scikit-learn==1.7.2 \
    matplotlib==3.10.6 \
    seaborn==0.13.2 \
    plotly==6.3.0

# Install Thinkube service clients - Deployed services
RUN python -m pip install --no-cache-dir --user \
    psycopg2-binary==2.9.10 \
    redis==6.4.0 \
    qdrant-client==1.15.1 \
    opensearch-py==3.0.0 \
    mlflow==3.4.0 \
    boto3==1.40.40

# Install Thinkube service clients - Planned services
RUN python -m pip install --no-cache-dir --user \
    weaviate-client==4.17.0 \
    litellm==1.77.5 \
    label-studio-sdk==2.0.9

# Install common utilities
RUN python -m pip install --no-cache-dir --user \
    python-dotenv==1.1.1 \
    requests==2.32.5 \
    httpx==0.28.1 \
    pydantic==2.11.9

# Add transformers and related libraries for ML workflows
RUN python -m pip install --no-cache-dir --user \
    transformers==4.56.2 \
    datasets==4.1.1 \
    accelerate==1.10.1

# Add user's local bin to PATH
ENV PATH="/home/jovyan/.local/bin:${PATH}"

# Copy Thinkube environment configuration
USER root
COPY .thinkube_env /home/jovyan/.thinkube_env
RUN chown $NB_UID:$NB_GID /home/jovyan/.thinkube_env
USER $NB_UID

# Source Thinkube environment in bashrc
RUN echo 'if [ -f /home/jovyan/.thinkube_env ]; then source /home/jovyan/.thinkube_env; fi' >> /home/jovyan/.bashrc

# Copy startup script (templated with correct image name)
USER root
COPY startup.sh /usr/local/bin/startup.sh
RUN chmod +x /usr/local/bin/startup.sh
USER $NB_UID

WORKDIR /home/jovyan

# Expose JupyterLab port
EXPOSE 8888

# Use startup script as entrypoint to handle examples, then run the command
ENTRYPOINT ["/usr/local/bin/startup.sh"]

# Default command for standalone use (JupyterHub will override with jupyterhub-singleuser)
CMD ["jupyter", "lab", "--ip=0.0.0.0", "--port=8888", "--no-browser", "--allow-root"]

# ðŸ¤– AI-assisted