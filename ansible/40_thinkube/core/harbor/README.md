# Harbor Container Registry

This directory contains Ansible playbooks for deploying and managing Harbor container registry on the Thinkube platform.

## Overview

Harbor is an open-source container registry that provides:
- Container image storage and distribution
- OIDC authentication integration with Keycloak
- Image vulnerability scanning
- Role-based access control
- Image replication
- Project isolation

## Playbooks

### 10_deploy.yaml
Main deployment playbook that:
- Creates Keycloak OIDC client for Harbor authentication
- Deploys Harbor using Helm chart
- Configures OIDC authentication
- Sets up persistent storage for all components

### 15_configure_thinkube.yaml
Post-deployment configuration that:
- Creates the 'thinkube' project in Harbor
- Creates a system-level robot account for Kubernetes deployments
- Generates pull secrets for Kubernetes
- Stores credentials in ~/.env

### 16_configure_default_registry.yaml
Registry configuration that:
- Updates MicroK8s default registry settings
- Configures Harbor as the default container registry
- Creates ConfigMap for registry hosting

### 17_mirror_public_images.yaml
Image mirroring playbook that:
- Creates a public library project
- Mirrors essential images from public registries
- Avoids Docker Hub rate limits
- Uses alternative sources (GCR, Quay.io, etc.)

### 18_test.yaml
Comprehensive test playbook that verifies:
- Kubernetes resources are properly deployed
- Harbor API is accessible
- OIDC authentication is configured
- Registry operations (push/pull) work correctly

### 19_rollback.yaml
Cleanup playbook that:
- Removes Harbor Helm release
- Deletes Harbor namespace
- Cleans up temporary files

## Dependencies

- **CORE-001**: MicroK8s Control Node
- **CORE-002**: MicroK8s Worker Nodes  
- **CORE-003**: Cert-Manager (for TLS)
- **CORE-004**: Keycloak (for SSO)

## Required Variables

Add these to your inventory:

```yaml
# Registry configuration
harbor_registry: "registry.thinkube.com"
harbor_namespace: "registry"
harbor_release: "harbor"
harbor_project: "thinkube"

# Storage configuration
harbor_storage_class: "microk8s-hostpath"
harbor_registry_size: "50Gi"
harbor_database_size: "10Gi"

# Admin configuration (inherited from global)
admin_username: "tkadmin"
# admin_password is provided via ADMIN_PASSWORD environment variable
```

## Environment Variables

- `ADMIN_PASSWORD`: Required for Keycloak authentication during deployment
- `HARBOR_ROBOT_TOKEN`: Generated by 15_configure_thinkube.yaml, required for image mirroring

## Usage

1. Deploy Harbor:
   ```bash
   cd ~/thinkube
   export ADMIN_PASSWORD="your-admin-password"
   ./scripts/run_ansible.sh ansible/40_thinkube/core/harbor/10_deploy.yaml
   ```

2. Configure thinkube project:
   ```bash
   ./scripts/run_ansible.sh ansible/40_thinkube/core/harbor/15_configure_thinkube.yaml
   ```

3. (Optional) Configure as default registry:
   ```bash
   ./scripts/run_ansible.sh ansible/40_thinkube/core/harbor/16_configure_default_registry.yaml
   ```

4. (Optional) Mirror public images:
   ```bash
   ./scripts/run_ansible.sh ansible/40_thinkube/core/harbor/17_mirror_public_images.yaml
   ```

5. Test the deployment:
   ```bash
   ./scripts/run_ansible.sh ansible/40_thinkube/core/harbor/18_test.yaml
   ```

## Post-Deployment

After successful deployment:

1. Access Harbor UI at https://registry.thinkube.com
2. Login using Keycloak SSO with your admin credentials
3. The 'thinkube' project is ready for use
4. Robot credentials are stored in ~/.env

## Registry Usage

### Docker/Podman Login
```bash
docker login registry.thinkube.com
# Use robot credentials from ~/.env or SSO credentials
```

### Push an Image
```bash
docker tag myimage:latest registry.thinkube.com/thinkube/myimage:latest
docker push registry.thinkube.com/thinkube/myimage:latest
```

### Pull an Image
```bash
docker pull registry.thinkube.com/thinkube/myimage:latest
```

### Kubernetes Pull Secret
The deployment creates a pull secret in the default namespace:
```yaml
imagePullSecrets:
  - name: harbor-pull-secret
```

## Troubleshooting

### Check Harbor Status
```bash
kubectl get pods -n registry
kubectl get svc -n registry
helm list -n registry
```

### View Logs
```bash
kubectl logs -n registry deployment/harbor-core
kubectl logs -n registry deployment/harbor-registry
```

### Verify OIDC Configuration
```bash
curl -I https://registry.thinkube.com
# Should redirect to Keycloak for authentication
```

## Rollback

To completely remove Harbor:
```bash
./scripts/run_ansible.sh ansible/40_thinkube/core/harbor/19_rollback.yaml
```

This will:
- Remove the Helm release
- Delete the namespace
- Clean up temporary files

## Notes

- Harbor includes its own PostgreSQL database and Redis instance
- Images are stored on persistent volumes using the configured storage class
- OIDC authentication is required; local user authentication is disabled
- The wildcard TLS certificate is copied from the default namespace
- Robot accounts are used for automated registry operations
- All installation-specific values must be defined in inventory
- Environment variables follow the project standard: ADMIN_PASSWORD, AUTH_REALM_PASSWORD

ðŸ¤– [AI-assisted]