# Copyright 2025 Alejandro Martínez Corriá and the Thinkube contributors
# SPDX-License-Identifier: Apache-2.0

---
# ansible/40_thinkube/optional/ollama/19_rollback.yaml
# Description:
#   Rollback Ollama deployment and clean up all resources
#
# Requirements:
#   - Kubernetes (k8s-snap) must be installed
#   - kubectl access configured
#
# Usage:
#   cd ~/thinkube
#   ./scripts/run_ansible.sh ansible/40_thinkube/optional/ollama/19_rollback.yaml
#
# Variables from inventory:
#   - kubeconfig: Path to kubectl configuration
#   - ollama_namespace: Namespace for Ollama

- name: Rollback Ollama deployment
  hosts: k8s_control_plane
  gather_facts: true

  vars:
    k8s_namespace: "{{ ollama_namespace | default('ollama') }}"

  tasks:
    - name: Delete Ollama namespace (and all resources within)
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig }}"
        state: absent
        kind: Namespace
        name: "{{ k8s_namespace }}"
      failed_when: false

    - name: Display rollback completion
      ansible.builtin.debug:
        msg:
          - "Ollama rollback completed"
          - "-----------------------------------"
          - "Removed namespace: {{ k8s_namespace }}"
          - "-----------------------------------"
          - "Note: Models stored on PVC are deleted"
          - "Note: JuiceFS MLflow volume is NOT deleted (shared storage)"
          - "-----------------------------------"
