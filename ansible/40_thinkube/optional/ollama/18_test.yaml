# Copyright 2025 Alejandro Martínez Corriá and the Thinkube contributors
# SPDX-License-Identifier: Apache-2.0

---
# ansible/40_thinkube/optional/ollama/18_test.yaml
# Description:
#   Test Ollama deployment - validates all components are running correctly
#
# Requirements:
#   - Ollama must be deployed (00_install.yaml)
#   - kubectl access configured
#
# Usage:
#   cd ~/thinkube
#   ./scripts/run_ansible.sh ansible/40_thinkube/optional/ollama/18_test.yaml
#
# Variables from inventory:
#   - kubeconfig: Path to kubectl configuration
#   - ollama_namespace: Namespace for Ollama

- name: Test Ollama deployment
  hosts: k8s_control_plane
  gather_facts: true

  vars:
    k8s_namespace: "{{ ollama_namespace | default('ollama') }}"
    ollama_host: "{{ ollama_hostname | default('ollama.' + domain_name) }}"

  tasks:
    ###########################################################################
    # Test 1: Namespace exists
    ###########################################################################
    - name: "TEST 1: Verify Ollama namespace exists"
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        kind: Namespace
        name: "{{ k8s_namespace }}"
      register: namespace_check
      failed_when: namespace_check.resources | length == 0

    - name: "TEST 1: Result"
      ansible.builtin.debug:
        msg: "✓ Namespace '{{ k8s_namespace }}' exists"

    ###########################################################################
    # Test 2: StatefulSet is running
    ###########################################################################
    - name: "TEST 2: Verify Ollama StatefulSet is running"
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        kind: StatefulSet
        name: ollama
        namespace: "{{ k8s_namespace }}"
      register: sts_check
      failed_when: >-
        sts_check.resources | length == 0 or
        (sts_check.resources[0].status.readyReplicas | default(0)) != 1

    - name: "TEST 2: Result"
      ansible.builtin.debug:
        msg: "✓ StatefulSet 'ollama' is running (1/1 ready)"

    ###########################################################################
    # Test 3: Service exists
    ###########################################################################
    - name: "TEST 3: Verify Ollama Service exists"
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        kind: Service
        name: ollama
        namespace: "{{ k8s_namespace }}"
      register: svc_check
      failed_when: svc_check.resources | length == 0

    - name: "TEST 3: Result"
      ansible.builtin.debug:
        msg: "✓ Service 'ollama' exists"

    ###########################################################################
    # Test 4: PVCs are bound
    ###########################################################################
    - name: "TEST 4a: Verify Ollama data PVC is bound"
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        kind: PersistentVolumeClaim
        name: ollama-data-pvc
        namespace: "{{ k8s_namespace }}"
      register: data_pvc_check
      failed_when: >-
        data_pvc_check.resources | length == 0 or
        data_pvc_check.resources[0].status.phase != 'Bound'

    - name: "TEST 4a: Result"
      ansible.builtin.debug:
        msg: "✓ PVC 'ollama-data-pvc' is bound"

    - name: "TEST 4b: Verify MLflow PVC is bound"
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        kind: PersistentVolumeClaim
        name: ollama-mlflow-pvc
        namespace: "{{ k8s_namespace }}"
      register: mlflow_pvc_check
      failed_when: >-
        mlflow_pvc_check.resources | length == 0 or
        mlflow_pvc_check.resources[0].status.phase != 'Bound'

    - name: "TEST 4b: Result"
      ansible.builtin.debug:
        msg: "✓ PVC 'ollama-mlflow-pvc' is bound (JuiceFS MLflow)"

    ###########################################################################
    # Test 5: Ingress is configured
    ###########################################################################
    - name: "TEST 5: Verify Ollama Ingress exists"
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        kind: Ingress
        name: ollama-ingress
        namespace: "{{ k8s_namespace }}"
      register: ingress_check
      failed_when: ingress_check.resources | length == 0

    - name: "TEST 5: Result"
      ansible.builtin.debug:
        msg: "✓ Ingress 'ollama-ingress' exists (host: {{ ollama_host }})"

    ###########################################################################
    # Test 6: Service discovery ConfigMap exists
    ###########################################################################
    - name: "TEST 6: Verify service discovery ConfigMap"
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        kind: ConfigMap
        name: thinkube-service-config
        namespace: "{{ k8s_namespace }}"
      register: configmap_check
      failed_when: configmap_check.resources | length == 0

    - name: "TEST 6: Result"
      ansible.builtin.debug:
        msg: "✓ Service discovery ConfigMap exists"

    ###########################################################################
    # Test 7: API responds
    ###########################################################################
    - name: "TEST 7: Test Ollama API response"
      ansible.builtin.uri:
        url: "http://ollama.{{ k8s_namespace }}.svc.cluster.local:11434/"
        method: GET
        status_code: 200
        timeout: 30
      register: api_check
      delegate_to: "{{ inventory_hostname }}"

    - name: "TEST 7: Result"
      ansible.builtin.debug:
        msg: "✓ Ollama API responds at http://ollama.{{ k8s_namespace }}.svc.cluster.local:11434/"

    ###########################################################################
    # Test 8: List models (API check)
    ###########################################################################
    - name: "TEST 8: Test Ollama model list API"
      ansible.builtin.uri:
        url: "http://ollama.{{ k8s_namespace }}.svc.cluster.local:11434/api/tags"
        method: GET
        status_code: 200
        timeout: 30
        return_content: true
      register: models_check
      delegate_to: "{{ inventory_hostname }}"

    - name: "TEST 8: Result"
      ansible.builtin.debug:
        msg: "✓ Ollama model list API works - {{ (models_check.json.models | default([])) | length }} models available"

    ###########################################################################
    # Summary
    ###########################################################################
    - name: Display test summary
      ansible.builtin.debug:
        msg:
          - "=========================================================="
          - "All Ollama tests passed!"
          - "=========================================================="
          - "Namespace: {{ k8s_namespace }}"
          - "StatefulSet: ollama (1/1 ready)"
          - "Service: ollama.{{ k8s_namespace }}.svc.cluster.local:11434"
          - "External: https://{{ ollama_host }}"
          - "Models: {{ (models_check.json.models | default([])) | length }}"
          - "=========================================================="
