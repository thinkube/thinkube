# Copyright 2025 Alejandro Mart√≠nez Corri√° and the Thinkube contributors
# SPDX-License-Identifier: Apache-2.0

---
# ansible/40_thinkube/optional/perses/10_configure_keycloak.yaml
# Description:
#   Configure Keycloak OIDC client for Perses with proper role mappings
#
# Requirements:
#   - Keycloak must be deployed and accessible
#   - ADMIN_PASSWORD environment variable must be set
#
# Usage:
#   cd ~/thinkube
#   ./scripts/tk_ansible ansible/40_thinkube/optional/perses/10_configure_keycloak.yaml
#
# Variables from inventory:
#   - domain_name: Base domain
#   - keycloak_realm: Keycloak realm name
#   - admin_username: Admin username for role assignments
#   - kubeconfig: Path to kubeconfig file
#
# Dependencies:
#   - Keycloak must be running
#
# ü§ñ AI-assisted

- name: Configure Keycloak "perses" client and setup OAuth
  hosts: microk8s_control_plane
  gather_facts: true

  vars:
    keycloak_admin_username: "{{ admin_username }}"
    keycloak_admin_password: "{{ lookup('env', 'ADMIN_PASSWORD') }}"
    keycloak_validate_certs: false
    perses_client_id: "perses"
    keycloak_admin_user_id: "{{ auth_realm_username }}"
    perses_namespace: "perses"
    perses_hostname: "perses.{{ domain_name }}"

  tasks:
    - name: Create Perses realm roles
      ansible.builtin.include_role:
        name: keycloak/keycloak_bulk_roles
      vars:
        keycloak_bulk_roles_list:
          - name: "perses-admin"
            description: "Perses administrator role"
          - name: "perses-user"
            description: "Perses standard user role"

    - name: Setup Perses Keycloak integration
      ansible.builtin.include_role:
        name: keycloak/keycloak_setup
      vars:
        keycloak_setup_client_id: "{{ perses_client_id }}"
        keycloak_setup_client_body:
          clientId: "{{ perses_client_id }}"
          enabled: true
          protocol: "openid-connect"
          standardFlowEnabled: true
          implicitFlowEnabled: false
          directAccessGrantsEnabled: true
          publicClient: false
          redirectUris:
            - "https://{{ perses_hostname }}/api/auth/providers/oidc/keycloak/callback"
            - "https://{{ perses_hostname }}/*"
          webOrigins:
            - "https://{{ perses_hostname }}"
            - "+"
          attributes:
            "access.token.lifespan": "3600"
            "post.logout.redirect.uris": "+"
          defaultClientScopes:
            - "email"
            - "profile"
            - "roles"
            - "openid"
            - "offline_access"
          optionalClientScopes:
            - "address"
            - "phone"

        keycloak_setup_client_mappers:
          - name: "perses-realm-role-mapper"
            protocol: "openid-connect"
            protocolMapper: "oidc-usermodel-realm-role-mapper"
            config:
              "claim.name": "realm_access.roles"
              "id.token.claim": "true"
              "access.token.claim": "true"
              "userinfo.token.claim": "true"
              "multivalued": "true"
              "jsonType.label": "String"

          - name: "perses-audience-mapper"
            protocol: "openid-connect"
            protocolMapper: "oidc-audience-mapper"
            config:
              "included.client.audience": "perses"
              "id.token.claim": "false"
              "access.token.claim": "true"
              "included.custom.audience": "perses"

          - name: "perses-client-role-mapper"
            protocol: "openid-connect"
            protocolMapper: "oidc-usermodel-client-role-mapper"
            config:
              "claim.name": "resource_access.${client_id}.roles"
              "client.id": "perses"
              "id.token.claim": "true"
              "access.token.claim": "true"
              "userinfo.token.claim": "true"
              "multivalued": "true"
              "jsonType.label": "String"

        keycloak_setup_user_roles:
          - username: "{{ keycloak_admin_user_id }}"
            role_name: "perses-admin"
            role_description: "Perses administrator role"
