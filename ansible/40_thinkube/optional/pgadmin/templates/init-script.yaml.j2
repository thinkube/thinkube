# Copyright 2025 Alejandro Martínez Corriá and the Thinkube contributors
# SPDX-License-Identifier: Apache-2.0

apiVersion: v1
kind: ConfigMap
metadata:
  name: pgadmin-init-script
  namespace: {{ pgadmin_namespace }}
data:
  init.py: |
    import json
    import os
    
    CONFIG_FILE = '/pgadmin4/config_local.py'
    
    # Load the JSON from oauth2_config.json
    with open('/config/oauth2_config.json', 'r') as f:
        data = json.load(f)
        OAUTH2_CONFIG = data['config']
    
    # Create the configuration content
    config_parts = [
        'import os',
        'DATA_DIR = "/var/lib/pgadmin"',
        'SESSION_DB_PATH = os.path.join(DATA_DIR, "sessions")',
        'STORAGE_DIR = os.path.join(DATA_DIR, "storage")',
        'SQLITE_PATH = os.path.join(DATA_DIR, "pgadmin4.db")',
        'LOG_FILE = os.path.join(DATA_DIR, "pgadmin4.log")',
        'OAUTH2_CONFIG = ' + json.dumps(OAUTH2_CONFIG, indent=2),
        
        # Authentication settings
        'AUTHENTICATION_SOURCES = ["oauth2"]',
        'OAUTH2_AUTO_CREATE_USER = True',
        'OAUTH2_ENABLED = True',
        'SERVER_MODE = True',
        'MASTER_PASSWORD_REQUIRED = False',
        'MASTER_PASSWORD = True',
        
        # URL and Security settings
        'PREFERRED_URL_SCHEME = "http"',
        'SECURITY_HTTPS_ONLY = False',
        'SECURITY_REDIRECT_HTTPS = False',
        
        # Cookie settings
        'SESSION_COOKIE_SECURE = True',
        'SESSION_COOKIE_SAMESITE = "Lax"',
        'CSRF_COOKIE_SECURE = True',
        'CSRF_COOKIE_SAMESITE = "Lax"',
        'CSRF_COOKIE_HTTPONLY = True',
        'COOKIE_DEFAULT_SECURE = True',
        'COOKIE_SAMESITE = "Lax"',
        'ENHANCED_COOKIE_PROTECTION = False',
        
        # Keys
        'CSRF_SESSION_KEY = "super-secret-key-123"',
        'SECRET_KEY = "another-super-secret-456"',
        
        # Logging
        'CONSOLE_LOG_LEVEL = 10',
        
        # Other settings
        'ALLOW_SAVE_PASSWORD = True',
        'USER_INACTIVITY_TIMEOUT = 0',
        'UPGRADE_CHECK_ENABLED = False'
    ]
    
    # Write the configuration file
    with open(CONFIG_FILE, 'w') as f:
        f.write('\n'.join(config_parts))