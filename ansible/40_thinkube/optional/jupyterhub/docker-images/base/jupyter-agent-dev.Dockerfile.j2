# Copyright 2025 Alejandro Martínez Corriá and the Thinkube contributors
# SPDX-License-Identifier: Apache-2.0

FROM {{ harbor_registry }}/library/jupyter-ml-cpu:latest

USER root

# Install additional system dependencies for agent development
RUN apt-get update && apt-get install -y \
    graphviz \
    && rm -rf /var/lib/apt/lists/*

# Install agent frameworks
RUN pip install --no-cache-dir --break-system-packages \
    langchain \
    langchain-community \
    langchain-openai \
    langgraph \
    langserve \
    langchain-experimental

# Install multi-agent frameworks
RUN pip install --no-cache-dir --break-system-packages \
    crewai \
    crewai-tools \
    autogen

# Install vector stores and tools
RUN pip install --no-cache-dir --break-system-packages \
    chromadb \
    qdrant-client \
    faiss-cpu \
    semantic-router \
    pinecone-client

# Install additional tools for agents
RUN pip install --no-cache-dir --break-system-packages \
    duckduckgo-search \
    wikipedia-api \
    arxiv \
    tavily-python \
    googlesearch-python \
    beautifulsoup4 \
    newspaper3k

# Install memory and state management tools
RUN pip install --no-cache-dir --break-system-packages \
    redis \
    memgpt \
    sqlalchemy \
    alembic

# Install observability tools
RUN pip install --no-cache-dir --break-system-packages \
    langfuse \
    phoenix-arize \
    opentelemetry-api \
    opentelemetry-sdk

# Install API and web frameworks
RUN pip install --no-cache-dir --break-system-packages \
    fastapi \
    uvicorn \
    gradio \
    streamlit

# Copy example notebooks (will be added during build)
COPY --chown=jovyan:jovyan notebooks/agents /home/jovyan/examples/agents || true

USER jovyan

# Create agent development directories
RUN mkdir -p /home/jovyan/notebooks/agents \
    && mkdir -p /home/jovyan/notebooks/tools \
    && mkdir -p /home/jovyan/notebooks/prompts \
    && mkdir -p /home/jovyan/notebooks/chains \
    && mkdir -p /home/jovyan/notebooks/crews

# Add environment variables for agent development
ENV LANGCHAIN_TRACING_V2=false
ENV LANGCHAIN_API_KEY=""

EXPOSE 8888
CMD ["jupyter", "lab", "--ip=0.0.0.0", "--no-browser", "--allow-root"]