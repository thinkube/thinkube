# Copyright 2025 Alejandro Martínez Corriá and the Thinkube contributors
# SPDX-License-Identifier: Apache-2.0

FROM {{ harbor_registry }}/library/jupyter-ml-cpu:latest

USER root

# Install additional system dependencies for agent development
RUN apt-get update && apt-get install -y \
    graphviz \
    && rm -rf /var/lib/apt/lists/*

# Install agent frameworks
RUN pip install --no-cache-dir --break-system-packages \
    langchain==0.3.10 \
    langchain-community==0.3.10 \
    langchain-openai==0.2.10 \
    langgraph==0.2.50 \
    langserve==0.3.0 \
    langchain-experimental==0.3.5

# Install multi-agent frameworks
RUN pip install --no-cache-dir --break-system-packages \
    crewai==0.1.35 \
    crewai-tools==0.0.15 \
    autogen==0.2.3

# Install vector stores and tools
RUN pip install --no-cache-dir --break-system-packages \
    chromadb==0.4.22 \
    qdrant-client==1.7.0 \
    faiss-cpu==1.7.4 \
    semantic-router==0.0.20 \
    pinecone-client==3.0.0

# Install additional tools for agents
RUN pip install --no-cache-dir --break-system-packages \
    duckduckgo-search==4.1.0 \
    wikipedia-api==0.6.0 \
    arxiv==2.1.0 \
    tavily-python==0.3.0 \
    googlesearch-python==1.2.3 \
    beautifulsoup4==4.12.2 \
    newspaper3k==0.2.8

# Install memory and state management tools
RUN pip install --no-cache-dir --break-system-packages \
    redis==5.0.1 \
    memgpt==0.2.11 \
    sqlalchemy==2.0.23 \
    alembic==1.13.1

# Install observability tools
RUN pip install --no-cache-dir --break-system-packages \
    langfuse==2.0.0 \
    phoenix-arize==3.0.0 \
    opentelemetry-api==1.21.0 \
    opentelemetry-sdk==1.21.0

# Install API and web frameworks
RUN pip install --no-cache-dir --break-system-packages \
    fastapi==0.108.0 \
    uvicorn==0.25.0 \
    gradio==4.13.0 \
    streamlit==1.29.0

# Copy example notebooks (will be added during build)
COPY --chown=jovyan:jovyan notebooks/agents /home/jovyan/examples/agents || true

USER jovyan

# Create agent development directories
RUN mkdir -p /home/jovyan/notebooks/agents \
    && mkdir -p /home/jovyan/notebooks/tools \
    && mkdir -p /home/jovyan/notebooks/prompts \
    && mkdir -p /home/jovyan/notebooks/chains \
    && mkdir -p /home/jovyan/notebooks/crews

# Add environment variables for agent development
ENV LANGCHAIN_TRACING_V2=false
ENV LANGCHAIN_API_KEY=""

EXPOSE 8888
CMD ["jupyter", "lab", "--ip=0.0.0.0", "--no-browser", "--allow-root"]