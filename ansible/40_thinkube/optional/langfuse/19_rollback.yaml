# Copyright 2025 Alejandro Mart√≠nez Corri√° and the Thinkube contributors
# SPDX-License-Identifier: Apache-2.0

---
# ansible/40_thinkube/optional/langfuse/19_rollback.yaml
# Description:
#   Rollback Langfuse deployment and clean up all resources
#
# Requirements:
#   - MicroK8s must be installed
#   - kubectl access configured
#
# Usage:
#   cd ~/thinkube
#   ./scripts/run_ansible.sh ansible/40_thinkube/optional/langfuse/19_rollback.yaml
#
# Variables from inventory:
#   - kubeconfig: Path to kubectl configuration
#   - kubectl_bin: Path to kubectl binary
#
# ü§ñ [AI-assisted]

- name: Rollback Langfuse deployment
  hosts: microk8s_control_plane
  gather_facts: true

  vars:
    k8s_namespace: "langfuse"
    postgres_admin_user: "{{ admin_username }}"
    langfuse_db_name: "langfuse_db"

  tasks:
    ###########################################################################
    # Step 1: Delete Kubernetes resources
    ###########################################################################
    - name: Delete Langfuse namespace (and all resources within)
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig }}"
        state: absent
        kind: Namespace
        name: "{{ k8s_namespace }}"
      failed_when: false

    ###########################################################################
    # Step 2: Clean up PostgreSQL database
    ###########################################################################
    - name: Get PostgreSQL admin password
      ansible.builtin.set_fact:
        postgres_admin_password: "{{ lookup('env', 'ADMIN_PASSWORD') }}"

    - name: Drop Langfuse database
      ansible.builtin.shell: |
        PGPASSWORD="{{ postgres_admin_password }}" psql -h {{ postgres_hostname }} -p 5432 -U {{ postgres_admin_user }} -d postgres -c "
        DROP DATABASE IF EXISTS {{ langfuse_db_name }};
        "
      register: db_drop
      become: true
      failed_when: false
      changed_when: "'DROP DATABASE' in db_drop.stdout"

    ###########################################################################
    # Step 3: Display rollback completion
    ###########################################################################
    - name: Display rollback completion
      ansible.builtin.debug:
        msg:
          - "Langfuse rollback completed"
          - "-----------------------------------"
          - "Removed namespace: {{ k8s_namespace }}"
          - "Dropped database: {{ langfuse_db_name }}"
          - "-----------------------------------"
